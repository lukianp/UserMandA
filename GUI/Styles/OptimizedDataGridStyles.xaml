<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Column Header Gripper Style (moved to top to fix forward reference) -->
    <Style x:Key="ColumnHeaderGripperStyle" TargetType="Thumb">
        <Setter Property="Width" Value="8"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Cursor" Value="SizeWE"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Thumb">
                    <Border Background="{TemplateBinding Background}" 
                            Padding="{TemplateBinding Padding}"/>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Optimized DataGrid Cell Template -->
    <ControlTemplate x:Key="OptimizedDataGridCellTemplate" TargetType="DataGridCell">
        <Border x:Name="CellBorder"
                Background="Transparent"
                BorderThickness="0"
                SnapsToDevicePixels="True">
            
            <ContentPresenter x:Name="CellContent"
                            Margin="4,2"
                            VerticalAlignment="Center"
                            SnapsToDevicePixels="True"/>
        </Border>
        
        <ControlTemplate.Triggers>
            <!-- Only essential visual states -->
            <Trigger Property="IsSelected" Value="True">
                <Setter TargetName="CellBorder" Property="Background" 
                        Value="{DynamicResource DataGridCellSelectedBackground}"/>
            </Trigger>
            <Trigger Property="IsKeyboardFocusWithin" Value="True">
                <Setter TargetName="CellBorder" Property="BorderBrush" 
                        Value="{DynamicResource AccentBrush}"/>
                <Setter TargetName="CellBorder" Property="BorderThickness" Value="1"/>
            </Trigger>
        </ControlTemplate.Triggers>
    </ControlTemplate>

    <!-- Optimized DataGrid Row Header Template -->
    <ControlTemplate x:Key="OptimizedDataGridRowHeaderTemplate" TargetType="DataGridRowHeader">
        <Border x:Name="RowHeaderBorder"
                Background="{DynamicResource DataGridRowHeaderBackground}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,1,0"
                Width="20"
                SnapsToDevicePixels="True">
            
            <ContentPresenter VerticalAlignment="Center" 
                            HorizontalAlignment="Center"
                            SnapsToDevicePixels="True"/>
        </Border>
        
        <ControlTemplate.Triggers>
            <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="RowHeaderBorder" Property="Background" 
                        Value="{DynamicResource DataGridRowHeaderHoverBackground}"/>
            </Trigger>
        </ControlTemplate.Triggers>
    </ControlTemplate>

    <!-- Optimized DataGrid Column Header Template -->
    <ControlTemplate x:Key="OptimizedDataGridColumnHeaderTemplate" TargetType="DataGridColumnHeader">
        <Grid x:Name="HeaderGrid">
            <Border x:Name="HeaderBorder"
                    Background="{DynamicResource DataGridColumnHeaderBackground}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,1,1"
                    Padding="8,4">
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Header Content -->
                    <ContentPresenter Grid.Column="0"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                    SnapsToDevicePixels="True"/>
                    
                    <!-- Sort Indicator -->
                    <Path x:Name="SortArrow" 
                          Grid.Column="1"
                          Fill="{DynamicResource ForegroundBrush}"
                          Margin="4,0,0,0"
                          VerticalAlignment="Center"
                          Width="8" Height="6"
                          Visibility="Collapsed"
                          Data="M 0,6 L 6,6 L 3,0 Z"/>
                </Grid>
            </Border>
            
            <!-- Resize Thumb -->
            <Thumb x:Name="PART_LeftHeaderGripper" 
                   HorizontalAlignment="Left"
                   Style="{StaticResource ColumnHeaderGripperStyle}"/>
            <Thumb x:Name="PART_RightHeaderGripper" 
                   HorizontalAlignment="Right"
                   Style="{StaticResource ColumnHeaderGripperStyle}"/>
        </Grid>
        
        <ControlTemplate.Triggers>
            <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="HeaderBorder" Property="Background" 
                        Value="{DynamicResource DataGridColumnHeaderHoverBackground}"/>
            </Trigger>
            <Trigger Property="SortDirection" Value="Ascending">
                <Setter TargetName="SortArrow" Property="Visibility" Value="Visible"/>
                <Setter TargetName="SortArrow" Property="Data" Value="M 0,6 L 6,6 L 3,0 Z"/>
            </Trigger>
            <Trigger Property="SortDirection" Value="Descending">
                <Setter TargetName="SortArrow" Property="Visibility" Value="Visible"/>
                <Setter TargetName="SortArrow" Property="Data" Value="M 0,0 L 6,0 L 3,6 Z"/>
            </Trigger>
        </ControlTemplate.Triggers>
    </ControlTemplate>

    <!-- Column Header Gripper Style moved to top of file -->

    <!-- Optimized DataGrid Row Template -->
    <ControlTemplate x:Key="OptimizedDataGridRowTemplate" TargetType="DataGridRow">
        <Border x:Name="RowBorder"
                Background="{TemplateBinding Background}"
                BorderBrush="{TemplateBinding BorderBrush}"
                BorderThickness="0"
                SnapsToDevicePixels="True">
            
            <SelectiveScrollingGrid>
                <SelectiveScrollingGrid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </SelectiveScrollingGrid.ColumnDefinitions>
                <SelectiveScrollingGrid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </SelectiveScrollingGrid.RowDefinitions>
                
                <!-- Row Header -->
                <DataGridRowHeader Grid.RowSpan="2" 
                                 Grid.Column="0"
                                 SelectiveScrollingGrid.SelectiveScrollingOrientation="Vertical"
                                 Visibility="{Binding HeadersVisibility, 
                                            ConverterParameter={x:Static DataGridHeadersVisibility.Row}, 
                                            Converter={x:Static DataGrid.HeadersVisibilityConverter}, 
                                            RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}}"/>
                
                <!-- Cells Presenter -->
                <DataGridCellsPresenter Grid.Column="1"
                                      ItemsPanel="{TemplateBinding ItemsPanel}"
                                      SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                
                <!-- Details Presenter (if details template is used) -->
                <DataGridDetailsPresenter Grid.Row="1" 
                                        Grid.Column="1"
                                        SelectiveScrollingGrid.SelectiveScrollingOrientation="{Binding AreRowDetailsFrozen, 
                                                                                               ConverterParameter={x:Static SelectiveScrollingOrientation.Vertical}, 
                                                                                               Converter={x:Static DataGrid.RowDetailsScrollingConverter}, 
                                                                                               RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}}"
                                        Visibility="{TemplateBinding DetailsVisibility}"/>
            </SelectiveScrollingGrid>
        </Border>
        
        <ControlTemplate.Triggers>
            <Trigger Property="IsSelected" Value="True">
                <Setter TargetName="RowBorder" Property="Background" 
                        Value="{DynamicResource DataGridRowSelectedBackground}"/>
            </Trigger>
            <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="RowBorder" Property="Background" 
                        Value="{DynamicResource DataGridRowHoverBackground}"/>
            </Trigger>
            <MultiTrigger>
                <MultiTrigger.Conditions>
                    <Condition Property="IsSelected" Value="True"/>
                    <Condition Property="IsMouseOver" Value="True"/>
                </MultiTrigger.Conditions>
                <Setter TargetName="RowBorder" Property="Background" 
                        Value="{DynamicResource DataGridRowSelectedHoverBackground}"/>
            </MultiTrigger>
        </ControlTemplate.Triggers>
    </ControlTemplate>

    <!-- Optimized DataGrid Template -->
    <ControlTemplate x:Key="OptimizedDataGridTemplate" TargetType="DataGrid">
        <Border Background="{TemplateBinding Background}"
                BorderBrush="{TemplateBinding BorderBrush}"
                BorderThickness="{TemplateBinding BorderThickness}"
                SnapsToDevicePixels="True"
                Padding="{TemplateBinding Padding}">
            
            <ScrollViewer x:Name="DG_ScrollViewer" 
                         Focusable="False"
                         CanContentScroll="True">
                <ScrollViewer.Template>
                    <ControlTemplate TargetType="ScrollViewer">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Top Left Corner -->
                            <Button Grid.Column="0" Grid.Row="0"
                                   Focusable="False"
                                   Style="{DynamicResource {ComponentResourceKey 
                                          ResourceId=DataGridSelectAllButtonStyle, 
                                          TypeInTargetAssembly={x:Type DataGrid}}}"
                                   Visibility="{Binding HeadersVisibility, 
                                              ConverterParameter={x:Static DataGridHeadersVisibility.All}, 
                                              Converter={x:Static DataGrid.HeadersVisibilityConverter}, 
                                              RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}}"
                                   Width="{Binding CellsPanelHorizontalOffset, 
                                                  RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}}"/>
                            
                            <!-- Column Headers -->
                            <DataGridColumnHeadersPresenter x:Name="PART_ColumnHeadersPresenter"
                                                           Grid.Column="1" Grid.Row="0"
                                                           Visibility="{Binding HeadersVisibility, 
                                                                      ConverterParameter={x:Static DataGridHeadersVisibility.Column}, 
                                                                      Converter={x:Static DataGrid.HeadersVisibilityConverter}, 
                                                                      RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}}"/>
                            
                            <!-- Main Content -->
                            <ScrollContentPresenter x:Name="PART_ScrollContentPresenter"
                                                  Grid.ColumnSpan="2" Grid.Row="1"
                                                  CanContentScroll="{TemplateBinding CanContentScroll}"/>
                            
                            <!-- Vertical ScrollBar -->
                            <ScrollBar x:Name="PART_VerticalScrollBar"
                                     Grid.Column="2" Grid.Row="1"
                                     Orientation="Vertical"
                                     ViewportSize="{TemplateBinding ViewportHeight}"
                                     Maximum="{TemplateBinding ScrollableHeight}"
                                     Visibility="{TemplateBinding ComputedVerticalScrollBarVisibility}"
                                     Value="{Binding VerticalOffset, Mode=OneWay, RelativeSource={RelativeSource TemplatedParent}}"/>
                            
                            <!-- Horizontal ScrollBar -->
                            <ScrollBar x:Name="PART_HorizontalScrollBar"
                                     Grid.Column="1" Grid.Row="2"
                                     Orientation="Horizontal"
                                     ViewportSize="{TemplateBinding ViewportWidth}"
                                     Maximum="{TemplateBinding ScrollableWidth}"
                                     Visibility="{TemplateBinding ComputedHorizontalScrollBarVisibility}"
                                     Value="{Binding HorizontalOffset, Mode=OneWay, RelativeSource={RelativeSource TemplatedParent}}"/>
                        </Grid>
                    </ControlTemplate>
                </ScrollViewer.Template>
                
                <ItemsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
            </ScrollViewer>
        </Border>
    </ControlTemplate>

    <!-- Optimized DataGrid Style -->
    <Style x:Key="OptimizedDataGridStyle" TargetType="DataGrid">
        <Setter Property="Template" Value="{StaticResource OptimizedDataGridTemplate}"/>
        <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
        <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
        <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
        <Setter Property="BorderThickness" Value="1"/>
        <Setter Property="RowDetailsVisibilityMode" Value="VisibleWhenSelected"/>
        <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
        <Setter Property="ScrollViewer.PanningMode" Value="Both"/>
        <Setter Property="Stylus.IsFlicksEnabled" Value="False"/>
        
        <!-- Performance optimizations -->
        <Setter Property="EnableRowVirtualization" Value="True"/>
        <Setter Property="EnableColumnVirtualization" Value="True"/>
        <Setter Property="VirtualizingPanel.IsVirtualizing" Value="True"/>
        <Setter Property="VirtualizingPanel.VirtualizationMode" Value="Recycling"/>
        <Setter Property="VirtualizingPanel.IsContainerVirtualizable" Value="True"/>
        <Setter Property="VirtualizingPanel.ScrollUnit" Value="Item"/>
        
        <!-- Row Style -->
        <Setter Property="RowStyle">
            <Setter.Value>
                <Style TargetType="DataGridRow">
                    <Setter Property="Template" Value="{StaticResource OptimizedDataGridRowTemplate}"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="SnapsToDevicePixels" Value="True"/>
                    <Setter Property="Validation.ErrorTemplate" Value="{x:Null}"/>
                    <Setter Property="ValidationErrorTemplate">
                        <Setter.Value>
                            <ControlTemplate>
                                <TextBlock Foreground="Red" Margin="2,0,0,0" Text="!" VerticalAlignment="Center"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Setter.Value>
        </Setter>
        
        <!-- Column Header Style -->
        <Setter Property="ColumnHeaderStyle">
            <Setter.Value>
                <Style TargetType="DataGridColumnHeader">
                    <Setter Property="Template" Value="{StaticResource OptimizedDataGridColumnHeaderTemplate}"/>
                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                    <Setter Property="HorizontalContentAlignment" Value="Left"/>
                    <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
                    <Setter Property="FontWeight" Value="Medium"/>
                    <Setter Property="FontSize" Value="{StaticResource FontSizeMedium}"/>
                </Style>
            </Setter.Value>
        </Setter>
        
        <!-- Row Header Style -->
        <Setter Property="RowHeaderStyle">
            <Setter.Value>
                <Style TargetType="DataGridRowHeader">
                    <Setter Property="Template" Value="{StaticResource OptimizedDataGridRowHeaderTemplate}"/>
                </Style>
            </Setter.Value>
        </Setter>
        
        <!-- Cell Style -->
        <Setter Property="CellStyle">
            <Setter.Value>
                <Style TargetType="DataGridCell">
                    <Setter Property="Template" Value="{StaticResource OptimizedDataGridCellTemplate}"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="BorderBrush" Value="Transparent"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="Padding" Value="4,2"/>
                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                </Style>
            </Setter.Value>
        </Setter>
        
        <!-- Alternating row colors for better readability -->
        <Setter Property="AlternatingRowBackground" Value="{DynamicResource AlternatingRowBrush}"/>
    </Style>

    <!-- Color Resources -->
    <SolidColorBrush x:Key="DataGridRowSelectedBackground" Color="{DynamicResource AccentColor}" Opacity="0.3"/>
    <SolidColorBrush x:Key="DataGridRowSelectedHoverBackground" Color="{DynamicResource AccentColor}" Opacity="0.4"/>
    <SolidColorBrush x:Key="DataGridRowHoverBackground" Color="{DynamicResource AccentColor}" Opacity="0.1"/>
    <SolidColorBrush x:Key="DataGridCellSelectedBackground" Color="{DynamicResource AccentColor}" Opacity="0.2"/>
    <SolidColorBrush x:Key="DataGridColumnHeaderBackground" Color="{DynamicResource SurfaceColor}"/>
    <SolidColorBrush x:Key="DataGridColumnHeaderHoverBackground" Color="{DynamicResource AccentColor}" Opacity="0.1"/>
    <SolidColorBrush x:Key="DataGridRowHeaderBackground" Color="{DynamicResource CardColor}"/>
    <SolidColorBrush x:Key="DataGridRowHeaderHoverBackground" Color="{DynamicResource AccentColor}" Opacity="0.1"/>
    <SolidColorBrush x:Key="AlternatingRowBrush" Color="{DynamicResource CardColor}" Opacity="0.3"/>

</ResourceDictionary>