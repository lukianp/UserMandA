<Window x:Class="MandADiscoverySuite.Windows.TargetProfilesWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:viewmodels="clr-namespace:MandADiscoverySuite.ViewModels"
        mc:Ignorable="d"
        Title="Target Profiles" Height="520" Width="820" WindowStartupLocation="CenterOwner">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>
    <Window.DataContext>
        <viewmodels:TargetProfilesViewModel />
    </Window.DataContext>
    <Grid Margin="12">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="12"/>
            <ColumnDefinition Width="3*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Target Profiles" FontSize="18" FontWeight="SemiBold"/>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Profiles list -->
            <DockPanel Grid.Column="0">
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Top">
                    <Button Content="Reload" Margin="0,0,8,8" Command="{Binding LoadCommand}"/>
                    <Button Content="New" Margin="0,0,8,8" Command="{Binding NewCommand}"/>
                    <Button Content="Set Active" Margin="0,0,8,8" Command="{Binding SetActiveCommand}"/>
                    <Button Content="Import From App Reg" Margin="0,0,8,8" Command="{Binding ImportFromAppRegCommand}"/>
                    <Button Content="Delete" Margin="0,0,8,8" Command="{Binding DeleteCommand}" IsEnabled="{Binding Path=Selected, Converter={StaticResource NullToBoolConverter}}" Visibility="Collapsed"/>
                </StackPanel>
                <ListBox ItemsSource="{Binding Profiles}" SelectedItem="{Binding Selected}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Vertical" Margin="4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding Name}"/>
                                    <TextBlock Text="  (Active)" Foreground="#38B2AC" FontWeight="SemiBold" Visibility="{Binding IsActive, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </StackPanel>
                                <TextBlock Text="{Binding TenantId}" FontSize="11" Foreground="#666"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>

            <!-- Editor -->
            <StackPanel Grid.Column="2">
                <Grid Margin="0,0,0,12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="160"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Margin="0,0,8,8" Text="Name:"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Margin="0,8,8,8" Text="Tenant ID:"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding TenantId, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Margin="0,8,8,8" Text="Client ID:"/>
                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding ClientId, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Margin="0,8,8,8" Text="Client Secret:"/>
                    <PasswordBox Grid.Row="3" Grid.Column="1" x:Name="SecretBox" PasswordChanged="SecretBox_PasswordChanged"/>

                    <TextBlock Grid.Row="4" Grid.Column="0" Margin="0,8,8,8" Text="Tenant Name:"/>
                    <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding Selected.TenantName, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="5" Grid.Column="0" Margin="0,8,8,8" Text="SharePoint URL:"/>
                    <TextBox Grid.Row="5" Grid.Column="1" Text="{Binding Selected.SharePointUrl, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="6" Grid.Column="0" Margin="0,8,8,8" Text="SQL Connection:"/>
                    <TextBox Grid.Row="6" Grid.Column="1" Text="{Binding Selected.SqlConnectionString, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="7" Grid.Column="0" Margin="0,8,8,8" Text="Scopes (CSV):"/>
                    <TextBox Grid.Row="7" Grid.Column="1" Text="{Binding ScopesCsv, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- Connection Status Display -->
                    <TextBlock Grid.Row="8" Grid.Column="0" Margin="0,8,8,8" Text="Last Test:" FontSize="11" Foreground="#666"/>
                    <StackPanel Grid.Row="8" Grid.Column="1" Orientation="Horizontal" Margin="0,8,0,0">
                        <TextBlock Text="{Binding Selected.LastConnectionTest, StringFormat='{}{0:MM/dd HH:mm}'}" FontSize="11" Foreground="#666"/>
                        <TextBlock Text=" - " FontSize="11" Foreground="#666" Visibility="{Binding Selected.LastConnectionTest, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <TextBlock Text="{Binding Selected.LastConnectionTestMessage}" FontSize="11" Foreground="#666"
                                   Visibility="{Binding Selected.LastConnectionTest, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </StackPanel>
                </Grid>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Test Connection" Width="140" Margin="0,0,8,0" Command="{Binding TestConnectionCommand}"/>
                    <Button Content="Save" Width="100" Command="{Binding SaveCommand}"/>
                    <Button Content="Close" Width="100" Margin="8,0,0,0" IsCancel="True"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <TextBlock Grid.Row="2" Text="Secrets are encrypted with Windows DPAPI (CurrentUser)." FontSize="11" Foreground="#666"/>
    </Grid>
</Window>
