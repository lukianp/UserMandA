<UserControl x:Class="MandADiscoverySuite.Views.ReportBuilderView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:MandADiscoverySuite.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             Background="{DynamicResource BackgroundBrush}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
            <Setter Property="Margin" Value="0,10,0,5"/>
        </Style>

        <Style x:Key="IconButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style x:Key="DataGridStyle" TargetType="DataGrid">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="SelectionMode" Value="Single"/>
            <Setter Property="RowHeaderWidth" Value="0"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource ToolbarBackgroundBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Padding="10,5">
            <StackPanel Orientation="Horizontal">
                <!-- File Operations -->
                <Button Content="ðŸ“„" ToolTip="New Report" Command="{Binding NewReportCommand}" Style="{StaticResource IconButtonStyle}"/>
                <Button Content="ðŸ“" ToolTip="Load Report" Style="{StaticResource IconButtonStyle}"/>
                <Button Content="ðŸ’¾" ToolTip="Save Report" Command="{Binding SaveReportCommand}" Style="{StaticResource IconButtonStyle}"/>
                <Button Content="ðŸ“‹" ToolTip="Save As" Command="{Binding SaveAsReportCommand}" Style="{StaticResource IconButtonStyle}"/>
                
                <Separator Margin="10,0"/>
                
                <!-- Mode Toggle -->
                <ToggleButton Content="ðŸŽ¨" ToolTip="Design Mode" IsChecked="{Binding IsDesignMode}" 
                             Command="{Binding SwitchToDesignModeCommand}" Style="{StaticResource {x:Type ToggleButton}}" Width="32" Height="32" Margin="2"/>
                <ToggleButton Content="ðŸ‘ï¸" ToolTip="Preview Mode" IsChecked="{Binding IsPreviewMode}" 
                             Command="{Binding SwitchToPreviewModeCommand}" Style="{StaticResource {x:Type ToggleButton}}" Width="32" Height="32" Margin="2"/>
                
                <Separator Margin="10,0"/>
                
                <!-- Execution -->
                <Button Content="â–¶ï¸" ToolTip="Execute Report" Command="{Binding ExecuteReportCommand}" 
                       Style="{StaticResource IconButtonStyle}" IsEnabled="{Binding CanExecuteReport}"/>
                <Button Content="ðŸ”" ToolTip="Preview Report" Command="{Binding PreviewReportCommand}" 
                       Style="{StaticResource IconButtonStyle}" IsEnabled="{Binding CanPreviewReport}"/>
                <Button Content="â¹ï¸" ToolTip="Cancel Execution" Command="{Binding CancelExecutionCommand}" 
                       Style="{StaticResource IconButtonStyle}" IsEnabled="{Binding IsExecuting}"/>
                
                <Separator Margin="10,0"/>
                
                <!-- Export -->
                <Button Content="ðŸ“¤" ToolTip="Export Report" Command="{Binding ExportReportCommand}" Style="{StaticResource IconButtonStyle}"/>
                
                <!-- Progress Indicator -->
                <ProgressBar Width="100" Height="20" Margin="10,0" IsIndeterminate="{Binding IsExecuting}" 
                           Visibility="{Binding IsExecuting, Converter={StaticResource BoolToVisibilityConverter}}"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="200"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="300" MinWidth="250"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Report List & Templates -->
            <Border Grid.Column="0" Background="{DynamicResource PanelBackgroundBrush}" 
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,1,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <!-- Reports Section -->
                        <TextBlock Text="Reports" Style="{StaticResource SectionHeaderStyle}"/>
                        <ListBox ItemsSource="{Binding Reports}" SelectedItem="{Binding SelectedReport}" 
                                MaxHeight="200" Background="Transparent" BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="5">
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Description}" FontSize="11" 
                                                  Foreground="{DynamicResource SecondaryTextBrush}"
                                                  TextWrapping="Wrap"/>
                                        <TextBlock FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}">
                                            <TextBlock.Text>
                                                <MultiBinding StringFormat="{}{0} â€¢ Modified: {1:MM/dd/yyyy}">
                                                    <Binding Path="ReportType"/>
                                                    <Binding Path="ModifiedDate"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <!-- Templates Section -->
                        <TextBlock Text="Templates" Style="{StaticResource SectionHeaderStyle}" Margin="0,20,0,5"/>
                        <ListBox ItemsSource="{Binding Templates}" SelectedItem="{Binding SelectedTemplate}" 
                                MaxHeight="200" Background="Transparent" BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="5">
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Description}" FontSize="11" 
                                                  Foreground="{DynamicResource SecondaryTextBrush}"
                                                  TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding Category}" FontSize="10" 
                                                  Foreground="{DynamicResource AccentBrush}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <Button Content="Create Template" Command="{Binding CreateTemplateCommand}" 
                               Margin="0,10,0,0" HorizontalAlignment="Stretch"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <GridSplitter Grid.Column="1" Background="{DynamicResource BorderBrush}"/>

            <!-- Center Panel - Design/Preview -->
            <Border Grid.Column="2" Background="{DynamicResource BackgroundBrush}">
                <Grid>
                    <!-- Design Mode -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                 Visibility="{Binding IsDesignMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Margin="20">
                            <!-- Report Information -->
                            <GroupBox Header="Report Information" Margin="0,0,0,20">
                                <Grid Margin="10">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Label Grid.Row="0" Grid.Column="0" Content="Name:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding ReportName, UpdateSourceTrigger=PropertyChanged}" 
                                            Margin="5,2"/>

                                    <Label Grid.Row="1" Grid.Column="0" Content="Description:" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding ReportDescription, UpdateSourceTrigger=PropertyChanged}" 
                                            AcceptsReturn="True" MinHeight="60" TextWrapping="Wrap" Margin="5,2"/>

                                    <Label Grid.Row="2" Grid.Column="0" Content="Type:" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Row="2" Grid.Column="1" SelectedItem="{Binding SelectedReportType}" 
                                             ItemsSource="{Binding ReportTypes}" Margin="5,2"/>

                                    <Label Grid.Row="3" Grid.Column="0" Content="Category:" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Row="3" Grid.Column="1" SelectedItem="{Binding SelectedCategory}" 
                                             ItemsSource="{Binding Categories}" IsEditable="True" Margin="5,2"/>
                                </Grid>
                            </GroupBox>

                            <!-- Data Sources -->
                            <GroupBox Header="Data Sources" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Available Data Sources -->
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="Available" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                            <ListBox ItemsSource="{Binding AvailableDataSources}" Height="120" 
                                                    Background="{DynamicResource BackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}"/>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </StackPanel>

                                        <!-- Add/Remove Buttons -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10">
                                            <Button Content="â–¶ï¸" Width="30" Height="30" Margin="2"
                                                   ToolTip="Add Data Source"/>
                                            <Button Content="â—€ï¸" Width="30" Height="30" Margin="2"
                                                   ToolTip="Remove Data Source"/>
                                        </StackPanel>

                                        <!-- Selected Data Sources -->
                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Selected" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                            <ListBox ItemsSource="{Binding SelectedDataSources}" Height="120" 
                                                    Background="{DynamicResource BackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Name}"/>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </GroupBox>

                            <!-- Columns -->
                            <GroupBox Header="Columns" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                        <Button Content="Add Column" Command="{Binding AddColumnCommand}" Margin="0,0,5,0"/>
                                        <Button Content="Remove" Command="{Binding RemoveColumnCommand}" Margin="0,0,5,0"/>
                                        <Button Content="Move Up" Command="{Binding MoveColumnUpCommand}" Margin="0,0,5,0"/>
                                        <Button Content="Move Down" Command="{Binding MoveColumnDownCommand}" Margin="0,0,5,0"/>
                                        <Button Content="Add Calculated" Command="{Binding AddCalculatedColumnCommand}"/>
                                    </StackPanel>

                                    <DataGrid ItemsSource="{Binding SelectedColumns}" SelectedItem="{Binding SelectedColumn}"
                                             Height="200" Style="{StaticResource DataGridStyle}" VirtualizingStackPanel.IsVirtualizing="True">
                                        <DataGrid.Columns>
                                            <DataGridCheckBoxColumn Header="Visible" Binding="{Binding IsVisible}" Width="60"/>
                                            <DataGridTextColumn Header="Field Name" Binding="{Binding FieldName}" Width="150" IsReadOnly="True"/>
                                            <DataGridTextColumn Header="Display Name" Binding="{Binding DisplayName}" Width="150"/>
                                            <DataGridTextColumn Header="Type" Binding="{Binding DataType}" Width="80" IsReadOnly="True"/>
                                            <DataGridTextColumn Header="Width" Binding="{Binding Width}" Width="60"/>
                                            <DataGridTextColumn Header="Order" Binding="{Binding Order}" Width="60"/>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <TextBlock Margin="0,5,0,0" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="Total: {0} columns, {1} visible">
                                                <Binding Path="TotalColumns"/>
                                                <Binding Path="VisibleColumns"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </GroupBox>

                            <!-- Filters -->
                            <GroupBox Header="Filters" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                        <Button Content="Add Filter" Command="{Binding AddFilterCommand}" Margin="0,0,5,0"/>
                                        <Button Content="Remove" Command="{Binding RemoveFilterCommand}" Margin="0,0,5,0"/>
                                        <Button Content="Edit" Command="{Binding EditFilterCommand}"/>
                                    </StackPanel>

                                    <DataGrid ItemsSource="{Binding ReportFilters}" Height="120" Style="{StaticResource DataGridStyle}"
                                             Visibility="{Binding HasFilters, Converter={StaticResource BoolToVisibilityConverter}}" VirtualizingStackPanel.IsVirtualizing="True">
                                        <DataGrid.Columns>
                                            <DataGridCheckBoxColumn Header="Enabled" Binding="{Binding IsEnabled}" Width="60"/>
                                            <DataGridTextColumn Header="Field" Binding="{Binding DisplayName}" Width="150"/>
                                            <DataGridTextColumn Header="Operator" Binding="{Binding Operator}" Width="100"/>
                                            <DataGridTextColumn Header="Value" Binding="{Binding Value}" Width="150"/>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <TextBlock Text="No filters defined" FontStyle="Italic" 
                                              Foreground="{DynamicResource SecondaryTextBrush}"
                                              Visibility="{Binding HasFilters, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Preview Mode -->
                    <WebBrowser Visibility="{Binding IsPreviewMode, Converter={StaticResource BoolToVisibilityConverter}}"
                               x:Name="PreviewBrowser"/>
                </Grid>
            </Border>

            <GridSplitter Grid.Column="3" Background="{DynamicResource BorderBrush}"/>

            <!-- Right Panel - Properties & History -->
            <Border Grid.Column="4" Background="{DynamicResource PanelBackgroundBrush}" 
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <!-- Report Properties -->
                        <TextBlock Text="Properties" Style="{StaticResource SectionHeaderStyle}"/>
                        <GroupBox Header="Formatting" Margin="0,0,0,10">
                            <StackPanel Margin="5">
                                <CheckBox Content="Show Grid Lines" IsChecked="True" Margin="0,2"/>
                                <CheckBox Content="Alternate Row Colors" IsChecked="True" Margin="0,2"/>
                                <CheckBox Content="Show Header" IsChecked="True" Margin="0,2"/>
                                <CheckBox Content="Show Footer" IsChecked="False" Margin="0,2"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Layout" Margin="0,0,0,10">
                            <StackPanel Margin="5">
                                <Label Content="Page Size:" Margin="0,2"/>
                                <ComboBox SelectedIndex="0" Margin="0,2">
                                    <ComboBoxItem Content="A4"/>
                                    <ComboBoxItem Content="Letter"/>
                                    <ComboBoxItem Content="Legal"/>
                                </ComboBox>
                                
                                <Label Content="Orientation:" Margin="0,5,0,2"/>
                                <ComboBox SelectedIndex="0" Margin="0,2">
                                    <ComboBoxItem Content="Portrait"/>
                                    <ComboBoxItem Content="Landscape"/>
                                </ComboBox>
                            </StackPanel>
                        </GroupBox>

                        <!-- Execution History -->
                        <TextBlock Text="Execution History" Style="{StaticResource SectionHeaderStyle}" Margin="0,20,0,5"/>
                        <ListBox ItemsSource="{Binding ExecutionHistory}" MaxHeight="200" 
                                Background="Transparent" BorderThickness="0"
                                Visibility="{Binding HasExecutionHistory, Converter={StaticResource BoolToVisibilityConverter}}">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="5">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Status}" FontWeight="SemiBold" Margin="0,0,5,0"/>
                                            <TextBlock Text="{Binding StartTime, StringFormat='{}{0:HH:mm:ss}'}" 
                                                      Foreground="{DynamicResource SecondaryTextBrush}"/>
                                        </StackPanel>
                                        <TextBlock FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}">
                                            <TextBlock.Text>
                                                <MultiBinding StringFormat="{}{0} records in {1:F1}s">
                                                    <Binding Path="RecordCount"/>
                                                    <Binding Path="Duration.TotalSeconds"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <TextBlock Text="No execution history" FontStyle="Italic" 
                                  Foreground="{DynamicResource SecondaryTextBrush}"/>

                        <!-- Current Execution Info -->
                        <GroupBox Header="Current Execution" Margin="0,10,0,0"
                                 Visibility="{Binding CurrentExecution, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Margin="5">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Status: " FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding CurrentExecution.Status}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                    <TextBlock Text="Records: " FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding CurrentExecution.RecordCount}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                    <TextBlock Text="Duration: " FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding CurrentExecution.Duration, StringFormat='{}{0:F2}s'}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,2"
                                           Visibility="{Binding CurrentExecution.ErrorMessage, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock Text="Error: " FontWeight="SemiBold" Foreground="Red"/>
                                    <TextBlock Text="{Binding CurrentExecution.ErrorMessage}" Foreground="Red" TextWrapping="Wrap"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{DynamicResource StatusBarBackgroundBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="{Binding ReportName}" FontWeight="SemiBold" Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding SelectedDataSources.Count, StringFormat='Data Sources: {0}'}" Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding SelectedColumns.Count, StringFormat='Columns: {0}'}" Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding ReportFilters.Count, StringFormat='Filters: {0}'}"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="Ready" Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding CurrentExecution.Status}" 
                              Visibility="{Binding CurrentExecution, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>