<UserControl x:Class="MandADiscoverySuite.Views.MigrationValidationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="clr-namespace:MandADiscoverySuite.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">

    <UserControl.Resources>
        <!-- Status Icon Converter -->
        <DataTemplate x:Key="StatusIconTemplate">
            <Grid Width="24" Height="24">
                <Ellipse Fill="Green" x:Name="SuccessIcon" Visibility="Collapsed"/>
                <Ellipse Fill="Orange" x:Name="WarningIcon" Visibility="Collapsed"/>
                <Ellipse Fill="Red" x:Name="ErrorIcon" Visibility="Collapsed"/>
                <Ellipse Fill="DarkRed" x:Name="CriticalIcon" Visibility="Collapsed"/>
                <Path Fill="White" x:Name="IconPath" Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Grid>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding Severity}" Value="Success">
                    <Setter TargetName="SuccessIcon" Property="Visibility" Value="Visible"/>
                    <Setter TargetName="IconPath" Property="Data" Value="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="Warning">
                    <Setter TargetName="WarningIcon" Property="Visibility" Value="Visible"/>
                    <Setter TargetName="IconPath" Property="Data" Value="M12,2L13.09,8.26L22,9L17,14L18.18,23L12,19.77L5.82,23L7,14L2,9L10.91,8.26L12,2Z"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="Error">
                    <Setter TargetName="ErrorIcon" Property="Visibility" Value="Visible"/>
                    <Setter TargetName="IconPath" Property="Data" Value="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="Critical">
                    <Setter TargetName="CriticalIcon" Property="Visibility" Value="Visible"/>
                    <Setter TargetName="IconPath" Property="Data" Value="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <!-- Issue Severity to Color Converter -->
        <Style x:Key="IssueSeverityTextStyle" TargetType="TextBlock">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Severity}" Value="Success">
                    <Setter Property="Foreground" Value="Green"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="Warning">
                    <Setter Property="Foreground" Value="Orange"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="Error">
                    <Setter Property="Foreground" Value="Red"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Severity}" Value="Critical">
                    <Setter Property="Foreground" Value="DarkRed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" Background="{DynamicResource HeaderBackgroundBrush}">
            <TextBlock Text="Post-Migration Validation" FontSize="24" FontWeight="Bold" Margin="10"/>
            <Button Content="Refresh Validation" Command="{Binding RefreshCommand}" Margin="10,5" Padding="15,8" Style="{StaticResource RoundedButtonStyle}"/>
            <Button Content="Validate Wave" Command="{Binding ValidateWaveCommand}" Margin="10,5" Padding="15,8" Style="{StaticResource RoundedButtonStyle}"/>
            <Button Content="Export Report" Command="{Binding ExportReportCommand}" Margin="10,5" Padding="15,8" Style="{StaticResource RoundedButtonStyle}"/>
        </StackPanel>

        <!-- Summary Statistics -->
        <Border Grid.Row="1" Background="{DynamicResource SummaryBackgroundBrush}" Margin="10,0,10,10" Padding="10" CornerRadius="5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Summary.TotalObjects}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                    <TextBlock Text="Total Objects" FontSize="12" HorizontalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Summary.SuccessfulObjects}" FontSize="24" FontWeight="Bold" Foreground="Green" HorizontalAlignment="Center"/>
                    <TextBlock Text="Successful" FontSize="12" HorizontalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Summary.WarningObjects}" FontSize="24" FontWeight="Bold" Foreground="Orange" HorizontalAlignment="Center"/>
                    <TextBlock Text="Warnings" FontSize="12" HorizontalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Summary.ErrorObjects}" FontSize="24" FontWeight="Bold" Foreground="Red" HorizontalAlignment="Center"/>
                    <TextBlock Text="Errors" FontSize="12" HorizontalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Summary.CriticalObjects}" FontSize="24" FontWeight="Bold" Foreground="DarkRed" HorizontalAlignment="Center"/>
                    <TextBlock Text="Critical" FontSize="12" HorizontalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="5" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Summary.SuccessRate, StringFormat='{}{0:F1}%'}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                    <TextBlock Text="Success Rate" FontSize="12" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <TabControl Grid.Row="2" Margin="10,0,10,10">
            <!-- Validation Results Tab -->
            <TabItem Header="Validation Results">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Filter Bar -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5" Background="{DynamicResource FilterBackgroundBrush}">
                        <TextBlock Text="Filter by Type:" VerticalAlignment="Center" Margin="5"/>
                        <ComboBox Width="120" Margin="5" SelectedItem="{Binding SelectedObjectTypeFilter}" ItemsSource="{Binding ObjectTypeFilters}"/>
                        
                        <TextBlock Text="Filter by Severity:" VerticalAlignment="Center" Margin="15,5,5,5"/>
                        <ComboBox Width="120" Margin="5" SelectedItem="{Binding SelectedSeverityFilter}" ItemsSource="{Binding SeverityFilters}"/>
                        
                        <TextBlock Text="Search:" VerticalAlignment="Center" Margin="15,5,5,5"/>
                        <TextBox Width="200" Margin="5" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
                        
                        <Button Content="Clear Filters" Command="{Binding ClearFiltersCommand}" Margin="15,5,5,5" Padding="10,5" Style="{StaticResource RoundedButtonStyle}"/>
                    </StackPanel>

                    <!-- Results DataGrid -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding FilteredValidationResults}" 
                              SelectedItem="{Binding SelectedValidationResult}"
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False" 
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              AlternatingRowBackground="{DynamicResource AlternatingRowBrush}"
                              SelectionMode="Extended" VirtualizingStackPanel.IsVirtualizing="True">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Status" Width="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ContentPresenter ContentTemplate="{StaticResource StatusIconTemplate}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <DataGridTextColumn Header="Object Type" Binding="{Binding ObjectType}" Width="100"/>
                            <DataGridTextColumn Header="Object Name" Binding="{Binding ObjectName}" Width="200"/>
                            
                            <DataGridTemplateColumn Header="Severity" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Severity}" Style="{StaticResource IssueSeverityTextStyle}" FontWeight="Bold"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <DataGridTextColumn Header="Message" Binding="{Binding Message}" Width="300"/>
                            <DataGridTextColumn Header="Issues" Binding="{Binding Issues.Count}" Width="60"/>
                            <DataGridTextColumn Header="Validated At" Binding="{Binding ValidatedAt, StringFormat='{}{0:MM/dd/yyyy HH:mm:ss}'}" Width="140"/>
                            
                            <DataGridTemplateColumn Header="Actions" Width="180">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Details" Command="{Binding DataContext.ShowDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}" Margin="2" Padding="8,4" Style="{StaticResource RoundedButtonStyle}"/>
                                            <Button Content="Rollback" Command="{Binding DataContext.RollbackCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}" Margin="2" Padding="8,4"
                                                    IsEnabled="{Binding CanRollback}" Background="IndianRed" Style="{StaticResource RoundedButtonStyle}"/>
                                            <Button Content="Revalidate" Command="{Binding DataContext.RevalidateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}" Margin="2" Padding="8,4" Style="{StaticResource RoundedButtonStyle}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <!-- Issue Details Tab -->
            <TabItem Header="Issue Details">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Selected Object Header -->
                    <Border Grid.Row="0" Background="{DynamicResource SelectedObjectBrush}" Margin="5" Padding="10" CornerRadius="5" 
                            Visibility="{Binding SelectedValidationResult, Converter={StaticResource NullToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="{Binding SelectedValidationResult.ObjectName}" FontSize="18" FontWeight="Bold"/>
                            <TextBlock Text="{Binding SelectedValidationResult.ObjectType}" FontSize="14" Opacity="0.8"/>
                            <TextBlock Text="{Binding SelectedValidationResult.Message}" FontSize="12" Margin="0,5,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Issues List -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding SelectedValidationResult.Issues}" 
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False" 
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              Margin="5"
                              Visibility="{Binding SelectedValidationResult, Converter={StaticResource NullToVisibilityConverter}}" VirtualizingStackPanel.IsVirtualizing="True">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Severity" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Severity}" Style="{StaticResource IssueSeverityTextStyle}" FontWeight="Bold"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="150"/>
                            <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*"/>
                            <DataGridTextColumn Header="Recommended Action" Binding="{Binding RecommendedAction}" Width="200"/>
                        </DataGrid.Columns>
                        
                        <DataGrid.RowDetailsTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource DetailsBrush}" Margin="20,5,5,5" Padding="10" CornerRadius="3">
                                    <StackPanel>
                                        <TextBlock Text="Technical Details:" FontWeight="Bold" Margin="0,0,0,5"/>
                                        <TextBox Text="{Binding TechnicalDetails, Mode=OneWay}" IsReadOnly="True" 
                                                 TextWrapping="Wrap" MaxHeight="200" VerticalScrollBarVisibility="Auto"
                                                 Background="Transparent" BorderThickness="0"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </DataGrid.RowDetailsTemplate>
                    </DataGrid>

                    <!-- No Selection Message -->
                    <TextBlock Grid.Row="1" Text="Select a validation result to view detailed issues" 
                               HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" Opacity="0.6"
                               Visibility="{Binding SelectedValidationResult, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Inverse}"/>
                </Grid>
            </TabItem>

            <!-- Rollback History Tab -->
            <TabItem Header="Rollback History">
                <DataGrid ItemsSource="{Binding RollbackHistory}" 
                          AutoGenerateColumns="False" 
                          CanUserAddRows="False" 
                          IsReadOnly="True"
                          GridLinesVisibility="Horizontal"
                          AlternatingRowBackground="{DynamicResource AlternatingRowBrush}" VirtualizingStackPanel.IsVirtualizing="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Object Type" Binding="{Binding ObjectType}" Width="100"/>
                        <DataGridTextColumn Header="Object Name" Binding="{Binding ObjectName}" Width="200"/>
                        <DataGridTextColumn Header="Success" Binding="{Binding Success}" Width="80"/>
                        <DataGridTextColumn Header="Message" Binding="{Binding Message}" Width="*"/>
                        <DataGridTextColumn Header="Rolled Back At" Binding="{Binding RolledBackAt, StringFormat='{}{0:MM/dd/yyyy HH:mm:ss}'}" Width="140"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <!-- Progress and Action Bar -->
        <Border Grid.Row="3" Background="{DynamicResource StatusBarBrush}" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Progress Information -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <controls:ProgressIndicator Visibility="{Binding IsValidating, Converter={StaticResource BoolToVisibilityConverter}}" Width="20" Height="20" Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" FontSize="12"/>
                    
                    <!-- Progress Bar for Operations -->
                    <ProgressBar Width="200" Height="20" Margin="20,0,0,0" 
                                 Value="{Binding ProgressPercentage}" 
                                 Maximum="100"
                                 Visibility="{Binding IsValidating, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Rollback Selected"
                            Command="{Binding RollbackSelectedCommand}"
                            Margin="5,0" Padding="15,8"
                            IsEnabled="{Binding HasSelectedItems}"
                            Background="IndianRed"
                            Style="{StaticResource RoundedButtonStyle}"/>
                    <Button Content="Rollback All Failed"
                            Command="{Binding RollbackAllFailedCommand}"
                            Margin="5,0" Padding="15,8"
                            IsEnabled="{Binding HasFailedItems}"
                            Background="DarkRed"
                            Style="{StaticResource RoundedButtonStyle}"/>
                    <Button Content="Cancel Operation"
                            Command="{Binding CancelOperationCommand}"
                            Margin="5,0" Padding="15,8"
                            IsEnabled="{Binding IsValidating}"
                            Style="{StaticResource RoundedButtonStyle}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>