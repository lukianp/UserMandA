<UserControl x:Class="MandADiscoverySuite.Views.PowerBIDiscoveryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1200">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Resources/Converters.xaml" />
                <ResourceDictionary Source="../Resources/DataGridTheme.xaml" />
                <ResourceDictionary Source="../Themes/ThemeStyles.xaml" />
                <ResourceDictionary Source="../Themes/Colors.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="Foreground" Value="#2D3748"/>
                <Setter Property="Margin" Value="0,0,0,8"/>
            </Style>
            <Style x:Key="FilterComboBoxStyle" TargetType="ComboBox">
                <Setter Property="MinWidth" Value="150"/>
                <Setter Property="Margin" Value="8,0"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>
            <Style x:Key="SearchTextBoxStyle" TargetType="TextBox">
                <Setter Property="MinWidth" Value="200"/>
                <Setter Property="Margin" Value="8,0"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="BorderBrush" Value="#E2E8F0"/>
                <Setter Property="Padding" Value="8,6"/>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Main Header Section -->
        <TextBlock Grid.Row="0" Text="Power BI Discovery" Style="{StaticResource HeaderTextStyle}" FontSize="24" FontWeight="SemiBold"/>
        <TextBlock Grid.Row="0" Text="Discover and manage Power BI workspaces, reports, datasets, and users"
                   FontSize="12" Foreground="{DynamicResource MutedForegroundBrush}" Margin="0,32,0,8"/>

        <!-- UniformGrid for 4 Summary Statistic Cards -->
        <UniformGrid Grid.Row="1" Columns="4" Margin="0,0,0,16">
            <!-- Workspaces Card -->
            <Border Background="#F0F9FF" BorderBrush="#3B82F6" BorderThickness="1" Padding="16" Margin="4" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="?? Workspaces" FontWeight="Bold" FontSize="14" Foreground="#1E40AF"/>
                    <TextBlock Text="{Binding TotalWorkspaces}" FontSize="32" FontWeight="Bold" Foreground="#3B82F6" Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
            <!-- Reports Card -->
            <Border Background="#F0FDF4" BorderBrush="#10B981" BorderThickness="1" Padding="16" Margin="4" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="?? Reports" FontWeight="Bold" FontSize="14" Foreground="#166534"/>
                    <TextBlock Text="{Binding TotalReports}" FontSize="32" FontWeight="Bold" Foreground="#10B981" Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
            <!-- Datasets Card -->
            <Border Background="#FEF3C7" BorderBrush="#F59E0B" BorderThickness="1" Padding="16" Margin="4" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="??? Datasets" FontWeight="Bold" FontSize="14" Foreground="#92400E"/>
                    <TextBlock Text="{Binding TotalDatasets}" FontSize="32" FontWeight="Bold" Foreground="#F59E0B" Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
            <!-- Users Card -->
            <Border Background="#FCE7F3" BorderBrush="#EC4899" BorderThickness="1" Padding="16" Margin="4" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="?? Users" FontWeight="Bold" FontSize="14" Foreground="#BE185D"/>
                    <TextBlock Text="{Binding TotalUsers}" FontSize="32" FontWeight="Bold" Foreground="#EC4899" Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
        </UniformGrid>

        <!-- ToolBar for Action Buttons -->
        <ToolBar Grid.Row="2" Margin="0,0,0,16">
            <Button Content="?? Run Discovery" Command="{Binding RunDiscoveryCommand}" Style="{StaticResource RoundedButtonStyle}" Padding="12,6" Margin="0,0,8,0"/>
            <Button Content="?? Refresh" Command="{Binding RefreshDataCommand}" Style="{StaticResource RoundedButtonStyle}" Padding="12,6" Margin="0,0,8,0"/>
            <Button Content="?? Export" Command="{Binding ExportCommand}" Style="{StaticResource RoundedButtonStyle}" Padding="12,6" Margin="0,0,8,0"/>
            <Button Content="?? Clear Filters" Style="{StaticResource RoundedButtonStyle}" Padding="12,6"/>
        </ToolBar>

        <!-- Grid with GridSplitter to separate DataGrid from Details Panel -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Loading Spinner -->
            <Border Grid.Column="0" Grid.ColumnSpan="3" Background="{DynamicResource SurfaceBrush}"
                    Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibility}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                    <TextBlock Text="{Binding ProcessingMessage, FallbackValue='Processing...'}" Margin="0,10,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- Main DataGrid -->
            <DataGrid Grid.Column="0"
                      ItemsSource="{Binding SelectedResults}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      GridLinesVisibility="Horizontal"
                      HeadersVisibility="Column"
                      Margin="0,0,0,20"
                      SelectedItem="{Binding SelectedItem}"
                      Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibility}}"
                      Style="{StaticResource StandardDataGridStyle}" VirtualizingStackPanel.IsVirtualizing="True">

                <DataGrid.Columns>
                    <DataGridTextColumn Header="Workspace Name" Binding="{Binding workspace}" Width="200"/>
                    <DataGridTextColumn Header="Report Name" Binding="{Binding reportname}" Width="200"/>
                    <DataGridTextColumn Header="Type" Binding="{Binding contenttype}" Width="100"/>
                    <DataGridTextColumn Header="Owner" Binding="{Binding owner}" Width="150"/>
                    <DataGridTextColumn Header="Last Refreshed" Binding="{Binding lastrefresh, StringFormat='{}{0:g}'}" Width="150"/>
                </DataGrid.Columns>
            </DataGrid>

            <!-- No Data Message -->
            <TextBlock Grid.Column="0"
                       Text="No Power BI data available. Run discovery to load data."
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       FontSize="16"
                       Foreground="{DynamicResource MutedForegroundBrush}"
                       Visibility="{Binding HasResults, Converter={StaticResource InverseBoolToVisibility}}"
                       TextWrapping="Wrap"
                       TextAlignment="Center"
                       Margin="20"/>

            <GridSplitter Grid.Column="1" Width="5" Background="Gray" HorizontalAlignment="Stretch" ResizeBehavior="PreviousAndNext"/>

            <!-- Right-hand Details Panel -->
            <Border Grid.Column="2" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                    Margin="0,0,0,20" CornerRadius="4"
                    Visibility="{Binding SelectedItem, Converter={StaticResource NullToVisibility}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="16">
                        <TextBlock Text="Power BI Item Details" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,16"/>

                        <!-- Dynamic details list from ViewModel -->
                        <ItemsControl ItemsSource="{Binding SelectedItemDetails}" Margin="0,-8,0,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,10,0,0">
                                        <TextBlock Text="{Binding Key}" FontSize="12" FontWeight="SemiBold" Foreground="{DynamicResource MutedForegroundBrush}"/>
                                        <TextBlock Text="{Binding Value}" FontSize="14" Margin="0,2,0,0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Footer -->
        <Border Grid.Row="4" Background="{DynamicResource SurfaceBrush}" Padding="16" Margin="0,16,0,0"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibility}}">
            <TextBlock Text="{Binding StatusText, FallbackValue='Ready'}" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource MutedForegroundBrush}"/>
        </Border>
    </Grid>
</UserControl>
