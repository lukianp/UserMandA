<UserControl x:Class="MandADiscoverySuite.Views.AuditView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:viewmodels="clr-namespace:MandADiscoverySuite.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">

    <UserControl.DataContext>
        <viewmodels:AuditViewModel />
    </UserControl.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#2C3E50" Padding="15">
            <TextBlock Text="Migration Audit and Reporting" 
                       FontSize="24" 
                       FontWeight="Bold" 
                       Foreground="White" 
                       HorizontalAlignment="Center" />
        </Border>

        <!-- Filter Panel -->
        <Expander Grid.Row="1" Header="Filters" IsExpanded="True" Margin="10">
            <Border BorderBrush="#BDC3C7" BorderThickness="1" Padding="15" Background="#ECF0F1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Row 1: Date Range and User Filter -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="5">
                        <TextBlock Text="Start Date:" FontWeight="Bold" />
                        <DatePicker SelectedDate="{Binding FilterStartDate}" />
                    </StackPanel>
                    
                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="5">
                        <TextBlock Text="End Date:" FontWeight="Bold" />
                        <DatePicker SelectedDate="{Binding FilterEndDate}" />
                    </StackPanel>

                    <StackPanel Grid.Row="0" Grid.Column="2" Margin="5">
                        <TextBlock Text="User Name:" FontWeight="Bold" />
                        <TextBox Text="{Binding FilterUserName, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <StackPanel Grid.Row="0" Grid.Column="3" Margin="5">
                        <TextBlock Text="Search Text:" FontWeight="Bold" />
                        <TextBox Text="{Binding FilterSearchText, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <!-- Row 2: Dropdown Filters -->
                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="5">
                        <TextBlock Text="Object Type:" FontWeight="Bold" />
                        <ComboBox ItemsSource="{Binding ObjectTypes}" 
                                  SelectedItem="{Binding FilterObjectType}" 
                                  DisplayMemberPath="."
                                  SelectedValuePath="." />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="5">
                        <TextBlock Text="Action:" FontWeight="Bold" />
                        <ComboBox ItemsSource="{Binding AuditActions}" 
                                  SelectedItem="{Binding FilterAction}" 
                                  DisplayMemberPath="."
                                  SelectedValuePath="." />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="2" Margin="5">
                        <TextBlock Text="Status:" FontWeight="Bold" />
                        <ComboBox ItemsSource="{Binding AuditStatuses}" 
                                  SelectedItem="{Binding FilterStatus}" 
                                  DisplayMemberPath="."
                                  SelectedValuePath="." />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="3" Margin="5">
                        <TextBlock Text="Wave:" FontWeight="Bold" />
                        <TextBox Text="{Binding FilterWave, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <!-- Row 3: Max Records and Buttons -->
                    <StackPanel Grid.Row="2" Grid.Column="0" Margin="5">
                        <TextBlock Text="Max Records:" FontWeight="Bold" />
                        <TextBox Text="{Binding MaxRecords}" />
                    </StackPanel>

                    <StackPanel Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="3" 
                                Orientation="Horizontal" 
                                HorizontalAlignment="Right" 
                                Margin="5" 
                                VerticalAlignment="Bottom">
                        <Button Content="Apply Filters" 
                                Command="{Binding LoadAuditEventsCommand}" 
                                Margin="5,0" 
                                Padding="15,5" 
                                Background="#3498DB" 
                                Foreground="White" 
                                BorderThickness="0" />
                        <Button Content="Clear" 
                                Command="{Binding ClearFiltersCommand}" 
                                Margin="5,0" 
                                Padding="15,5" 
                                Background="#95A5A6" 
                                Foreground="White" 
                                BorderThickness="0" />
                        <Button Content="Refresh" 
                                Command="{Binding RefreshCommand}" 
                                Margin="5,0" 
                                Padding="15,5" 
                                Background="#27AE60" 
                                Foreground="White" 
                                BorderThickness="0" />
                    </StackPanel>
                </Grid>
            </Border>
        </Expander>

        <!-- Statistics Panel -->
        <Expander Grid.Row="2" Header="Statistics" IsExpanded="False" Margin="10">
            <Border BorderBrush="#BDC3C7" BorderThickness="1" Padding="15" Background="#F8F9FA">
                <Grid DataContext="{Binding Statistics}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Statistics Row 1 -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="10">
                        <TextBlock Text="Total Events" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding TotalEvents}" FontSize="24" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="10">
                        <TextBlock Text="Successful" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding SuccessfulOperations}" FontSize="24" Foreground="Green" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel Grid.Row="0" Grid.Column="2" Margin="10">
                        <TextBlock Text="Failed" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding FailedOperations}" FontSize="24" Foreground="Red" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel Grid.Row="0" Grid.Column="3" Margin="10">
                        <TextBlock Text="Success Rate" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding SuccessRate, StringFormat={}{0:F1}%}" FontSize="24" HorizontalAlignment="Center" />
                    </StackPanel>

                    <!-- Statistics Row 2 -->
                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="10">
                        <TextBlock Text="Warnings" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding WarningOperations}" FontSize="18" Foreground="Orange" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="10">
                        <TextBlock Text="Avg Duration" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding AverageOperationDuration, StringFormat={}{0:hh\\:mm\\:ss}}" FontSize="18" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="2" Margin="10">
                        <TextBlock Text="Data Processed" FontWeight="Bold" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding TotalDataProcessed, StringFormat={}{0:N0} bytes}" FontSize="18" HorizontalAlignment="Center" />
                    </StackPanel>

                    <StackPanel Grid.Row="1" Grid.Column="3" Margin="10">
                        <!-- Placeholder for chart or additional metric -->
                    </StackPanel>
                </Grid>
            </Border>
        </Expander>

        <!-- Data Grid -->
        <DataGrid Grid.Row="3" 
                  ItemsSource="{Binding AuditEvents}" 
                  SelectedItem="{Binding SelectedAuditEvent}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  IsReadOnly="True"
                  Margin="10"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="Column"
                  AlternatingRowBackground="#F8F9FA" VirtualizingStackPanel.IsVirtualizing="True">

            <DataGrid.Columns>
                <DataGridTextColumn Header="Timestamp" 
                                    Binding="{Binding Timestamp, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}" 
                                    Width="140" />
                <DataGridTextColumn Header="User" 
                                    Binding="{Binding UserPrincipalName}" 
                                    Width="150" />
                <DataGridTextColumn Header="Action" 
                                    Binding="{Binding Action}" 
                                    Width="100" />
                <DataGridTextColumn Header="Object Type" 
                                    Binding="{Binding ObjectType}" 
                                    Width="120" />
                <DataGridTextColumn Header="Object Name" 
                                    Binding="{Binding SourceObjectName}" 
                                    Width="200" />
                <DataGridTextColumn Header="Wave" 
                                    Binding="{Binding WaveName}" 
                                    Width="150" />
                <DataGridTextColumn Header="Status" 
                                    Binding="{Binding Status}" 
                                    Width="100">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="Foreground" Value="{Binding StatusColor}" />
                            <Setter Property="FontWeight" Value="Bold" />
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
                <DataGridTextColumn Header="Duration" 
                                    Binding="{Binding DurationDisplay}" 
                                    Width="100" />
                <DataGridTextColumn Header="Data Size" 
                                    Binding="{Binding DataSizeDisplay}" 
                                    Width="100" />
                <DataGridTextColumn Header="Error Message" 
                                    Binding="{Binding ErrorMessage}" 
                                    Width="300" />
            </DataGrid.Columns>
        </DataGrid>

        <!-- Action Panel -->
        <Border Grid.Row="4" Background="#34495E" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Status Message -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Status: " Foreground="White" FontWeight="Bold" />
                    <TextBlock Text="{Binding StatusMessage}" Foreground="White" />
                    <ProgressBar Width="200" 
                                 Height="15" 
                                 Margin="10,0" 
                                 Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                                 IsIndeterminate="True" />
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Export CSV" 
                            Command="{Binding ExportToCsvCommand}" 
                            Margin="5,0" 
                            Padding="15,5" 
                            Background="#E67E22" 
                            Foreground="White" 
                            BorderThickness="0" />
                    <Button Content="Export PDF" 
                            Command="{Binding ExportToPdfCommand}" 
                            Margin="5,0" 
                            Padding="15,5" 
                            Background="#8E44AD" 
                            Foreground="White" 
                            BorderThickness="0" />
                    <Button Content="Archive Old" 
                            Command="{Binding ArchiveOldRecordsCommand}" 
                            Margin="5,0" 
                            Padding="15,5" 
                            Background="#E74C3C" 
                            Foreground="White" 
                            BorderThickness="0" />
                    <Button Content="Validate DB" 
                            Command="{Binding ValidateIntegrityCommand}" 
                            Margin="5,0" 
                            Padding="15,5" 
                            Background="#16A085" 
                            Foreground="White" 
                            BorderThickness="0" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>