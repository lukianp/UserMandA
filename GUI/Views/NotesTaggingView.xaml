<UserControl x:Class="MandADiscoverySuite.Views.NotesTaggingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    
    <UserControl.Resources>
        <!-- Tag Color to Brush Converter -->
        <Style x:Key="TagStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Background" Value="{Binding Color, FallbackValue=DodgerBlue}"/>
        </Style>

        <!-- Priority Color Converter -->
        <Style x:Key="PriorityIndicator" TargetType="Border">
            <Setter Property="Width" Value="8"/>
            <Setter Property="Height" Value="8"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Margin" Value="5,0"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Priority}" Value="Low">
                    <Setter Property="Background" Value="Gray"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Priority}" Value="Normal">
                    <Setter Property="Background" Value="Green"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Priority}" Value="High">
                    <Setter Property="Background" Value="Orange"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Priority}" Value="Critical">
                    <Setter Property="Background" Value="Red"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Background="#F5F5F5" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- View Toggle and Search -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="10">
                <!-- View Toggle -->
                <ToggleButton x:Name="NotesViewToggle" Content="Notes" IsChecked="{Binding IsNotesView}" 
                             Command="{Binding ShowNotesViewCommand}" Width="80" Height="30" Margin="0,0,5,0"/>
                <ToggleButton Content="Tags" IsChecked="{Binding IsNotesView, Converter={StaticResource InverseBooleanConverter}}" 
                             Command="{Binding ShowTagsViewCommand}" Width="80" Height="30" Margin="0,0,10,0"/>

                <!-- Search Box -->
                <TextBox x:Name="SearchBox" 
                         Width="200" Height="30" VerticalContentAlignment="Center">
                    <TextBox.Style>
                        <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                            <Setter Property="Text" Value="{Binding NoteSearchText, UpdateSourceTrigger=PropertyChanged}"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsNotesView}" Value="False">
                                    <Setter Property="Text" Value="{Binding TagSearchText, UpdateSourceTrigger=PropertyChanged}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <!-- Filter Toggle -->
                <Button Content="ðŸ” Filter" Command="{Binding ToggleFilterPanelCommand}" 
                       Width="80" Height="30" Margin="10,0,0,0"/>
            </StackPanel>

            <!-- Action Buttons -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="10">
                <Button Content="âž• New Note" Command="{Binding CreateNoteCommand}" 
                       Width="90" Height="30" Margin="5,0" 
                       Visibility="{Binding IsNotesView, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                <Button Content="âž• New Tag" Command="{Binding CreateTagCommand}" 
                       Width="90" Height="30" Margin="5,0"
                       Visibility="{Binding IsNotesView, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                <Button Content="ðŸ”„ Refresh" Command="{Binding RefreshDataCommand}" Width="70" Height="30" Margin="5,0"/>
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Notes View -->
            <Grid Grid.Column="0" Visibility="{Binding IsNotesView, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Notes List -->
                <ListView ItemsSource="{Binding FilteredNotes}" 
                         SelectedItem="{Binding SelectedNote}"
                         SelectionMode="Extended">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Priority" Width="60">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Style="{StaticResource PriorityIndicator}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Title" Width="200" DisplayMemberBinding="{Binding Title}"/>
                            
                            <GridViewColumn Header="Content" Width="300">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Content}" TextTrimming="WordEllipsis" MaxWidth="280"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Type" Width="100" DisplayMemberBinding="{Binding Type}"/>
                            
                            <GridViewColumn Header="Tags" Width="200">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <ItemsControl ItemsSource="{Binding Tags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="LightBlue" CornerRadius="8" Padding="4,2" Margin="2">
                                                        <TextBlock Text="{Binding}" FontSize="10" Foreground="DarkBlue"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Modified" Width="120" DisplayMemberBinding="{Binding LastModified, StringFormat='{}{0:MM/dd/yyyy HH:mm}'}"/>

                            <GridViewColumn Header="Actions" Width="100">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="âœï¸" Command="{Binding DataContext.EditNoteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                   CommandParameter="{Binding}" Width="25" Height="25" Margin="1" ToolTip="Edit"/>
                                            <Button Content="ðŸ“Œ" Command="{Binding DataContext.PinNoteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                   CommandParameter="{Binding}" Width="25" Height="25" Margin="1" ToolTip="Pin"
                                                   Visibility="{Binding IsPinned, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                            <Button Content="ðŸ“" Command="{Binding DataContext.UnpinNoteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                   CommandParameter="{Binding}" Width="25" Height="25" Margin="1" ToolTip="Unpin"
                                                   Visibility="{Binding IsPinned, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                            <Button Content="ðŸ—‘ï¸" Command="{Binding DataContext.DeleteNoteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                   CommandParameter="{Binding}" Width="25" Height="25" Margin="1" ToolTip="Delete"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>

            <!-- Tags View -->
            <Grid Grid.Column="0" Visibility="{Binding IsNotesView, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                <!-- Tags List -->
                <ListView ItemsSource="{Binding FilteredTags}" 
                         SelectedItem="{Binding SelectedTag}"
                         SelectionMode="Extended">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Name" Width="200" DisplayMemberBinding="{Binding Name}"/>
                            
                            <GridViewColumn Header="Color" Width="80">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Rectangle Fill="{Binding Color}" Width="50" Height="20" RadiusX="4" RadiusY="4"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="Category" Width="120" DisplayMemberBinding="{Binding Category}"/>
                            <GridViewColumn Header="Usage Count" Width="100" DisplayMemberBinding="{Binding UsageCount}"/>
                            <GridViewColumn Header="Description" Width="250" DisplayMemberBinding="{Binding Description}"/>
                            <GridViewColumn Header="Created" Width="120" DisplayMemberBinding="{Binding CreatedDate, StringFormat='{}{0:MM/dd/yyyy}'}"/>

                            <GridViewColumn Header="Actions" Width="80">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="âœï¸" Command="{Binding DataContext.EditTagCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                   CommandParameter="{Binding}" Width="25" Height="25" Margin="1" ToolTip="Edit"/>
                                            <Button Content="ðŸ—‘ï¸" Command="{Binding DataContext.DeleteTagCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                   CommandParameter="{Binding}" Width="25" Height="25" Margin="1" ToolTip="Delete"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>

            <!-- Filter Panel -->
            <Border Grid.Column="1" Width="250" Background="#F8F8F8" BorderBrush="#E0E0E0" BorderThickness="1,0,0,0"
                   Visibility="{Binding ShowFilterPanel, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="Filters" FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>

                        <!-- Note Type Filter -->
                        <TextBlock Text="Note Type:" Margin="0,5,0,2"/>
                        <ComboBox ItemsSource="{Binding NoteTypes}" 
                                 SelectedItem="{Binding CurrentFilter.SelectedType}"
                                 DisplayMemberPath="." Margin="0,0,0,10"/>

                        <!-- Priority Filter -->
                        <TextBlock Text="Priority:" Margin="0,5,0,2"/>
                        <ComboBox ItemsSource="{Binding NotePriorities}" 
                                 SelectedItem="{Binding CurrentFilter.SelectedPriority}"
                                 DisplayMemberPath="." Margin="0,0,0,10"/>

                        <!-- Date Range -->
                        <TextBlock Text="Date From:" Margin="0,5,0,2"/>
                        <DatePicker SelectedDate="{Binding CurrentFilter.DateFrom}" Margin="0,0,0,5"/>
                        
                        <TextBlock Text="Date To:" Margin="0,5,0,2"/>
                        <DatePicker SelectedDate="{Binding CurrentFilter.DateTo}" Margin="0,0,0,10"/>

                        <!-- Show Pinned Only -->
                        <CheckBox Content="Show Pinned Only" 
                                 IsChecked="{Binding CurrentFilter.ShowPinnedOnly}" Margin="0,5"/>

                        <!-- Filter Actions -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,20,0,0">
                            <Button Content="Apply" Command="{Binding ApplyFilterCommand}" Width="60" Height="25" Margin="5"/>
                            <Button Content="Clear" Command="{Binding ClearFilterCommand}" Width="60" Height="25" Margin="5"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Height="25">
            <StatusBarItem>
                <Grid>
                    <TextBlock Text="{Binding FilteredNotes.Count, StringFormat='Notes: {0}'}" 
                              Visibility="{Binding IsNotesView, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    <TextBlock Text="{Binding FilteredTags.Count, StringFormat='Tags: {0}'}" 
                              Visibility="{Binding IsNotesView, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                </Grid>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock Text="{Binding ErrorMessage}" Foreground="Red"/>
            </StatusBarItem>
        </StatusBar>

        <!-- Note Editor Modal -->
        <Border Grid.RowSpan="3" Background="#80000000" 
               Visibility="{Binding ShowNoteEditor, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border Background="White" Width="500" Height="400" CornerRadius="8" 
                   HorizontalAlignment="Center" VerticalAlignment="Center">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="{Binding IsEditingNote, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='Edit Note|Create Note'}" 
                              FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>

                    <TextBlock Grid.Row="1" Text="Title:" Margin="0,5,0,2"/>
                    <TextBox Grid.Row="1" Text="{Binding NewNoteTitle}" Margin="0,20,0,10"/>

                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Margin="0,0,5,0">
                            <TextBlock Text="Type:" Margin="0,5,0,2"/>
                            <ComboBox ItemsSource="{Binding NoteTypes}" SelectedItem="{Binding NewNoteType}"/>
                        </StackPanel>
                        
                        <StackPanel Grid.Column="1" Margin="5,0,0,0">
                            <TextBlock Text="Priority:" Margin="0,5,0,2"/>
                            <ComboBox ItemsSource="{Binding NotePriorities}" SelectedItem="{Binding NewNotePriority}"/>
                        </StackPanel>
                    </Grid>

                    <TextBlock Grid.Row="3" Text="Content:" Margin="0,15,0,2"/>
                    <TextBox Grid.Row="4" Text="{Binding NewNoteContent}" 
                            AcceptsReturn="True" TextWrapping="Wrap" VerticalScrollBarVisibility="Auto"/>

                    <StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                        <Button Content="Save" Command="{Binding SaveNoteCommand}" Width="70" Height="30" Margin="5,0"/>
                        <Button Content="Cancel" Command="{Binding CancelNoteEditCommand}" Width="70" Height="30" Margin="5,0"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- Tag Editor Modal -->
        <Border Grid.RowSpan="3" Background="#80000000" 
               Visibility="{Binding ShowTagEditor, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border Background="White" Width="400" Height="300" CornerRadius="8" 
                   HorizontalAlignment="Center" VerticalAlignment="Center">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="{Binding IsEditingTag, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='Edit Tag|Create Tag'}" 
                              FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>

                    <TextBlock Grid.Row="1" Text="Name:" Margin="0,5,0,2"/>
                    <TextBox Grid.Row="1" Text="{Binding NewTagName}" Margin="0,20,0,10"/>

                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="100"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Margin="0,0,5,0">
                            <TextBlock Text="Category:" Margin="0,5,0,2"/>
                            <ComboBox ItemsSource="{Binding TagCategories}" SelectedItem="{Binding NewTagCategory}"/>
                        </StackPanel>
                        
                        <StackPanel Grid.Column="1" Margin="5,0,0,0">
                            <TextBlock Text="Color:" Margin="0,5,0,2"/>
                            <TextBox Text="{Binding NewTagColor}" Margin="0,20,0,0"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                        <Button Content="Save" Command="{Binding SaveTagCommand}" Width="70" Height="30" Margin="5,0"/>
                        <Button Content="Cancel" Command="{Binding CancelTagEditCommand}" Width="70" Height="30" Margin="5,0"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>
    </Grid>
</UserControl>