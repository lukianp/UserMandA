<UserControl x:Class="MandADiscoverySuite.Views.Modules.UsersViewModule"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:behaviors="clr-namespace:MandADiscoverySuite.Behaviors"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1200">
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="32">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,24">
                <StackPanel>
                    <TextBlock Text="User Accounts" Style="{StaticResource HeaderTextStyle}"/>
                    <TextBlock Text="Comprehensive view of all discovered user accounts and profiles" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="16"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="32,0,0,0">
                    <!-- Refresh Status Indicator -->
                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="4" Padding="8,6" Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ•’" FontSize="12" Margin="0,0,6,0" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding RefreshService.ViewStatuses[Users].LastRefreshText}"
                                       Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                    <!-- Progress Bar -->
                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="4" Padding="4" Margin="0,0,8,0"
                            Visibility="{Binding RefreshService.ViewStatuses[Users].IsRefreshing, Converter={StaticResource BoolToVisibilityConverter}}">
                        <ProgressBar Width="60" Height="16"
                                   Value="{Binding RefreshService.ViewStatuses[Users].RefreshProgress}"
                                   Background="{DynamicResource CardBrush}" Foreground="{DynamicResource SuccessBrush}" BorderThickness="0"/>
                    </Border>
                    <!-- User Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="4" Padding="8,6" Margin="0,0,12,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#x1F4CA;" FontSize="14" Margin="0,0,6,0" VerticalAlignment="Center"/>
                            <TextBlock x:Name="UserResultCount" Text="0 users" Foreground="{DynamicResource AccentBrush}"
                                       FontSize="12" FontWeight="Medium" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                    <!-- Refresh Buttons -->
                    <Button Content="ðŸ”„" ToolTip="Refresh Users" Style="{StaticResource RoundedButtonStyle}"
                            Background="{StaticResource AccentGradient}" Command="{Binding RefreshUsersCommand}"
                            Width="32" Height="32" Margin="0,0,8,0" FontSize="14"/>
                    <Button Content="âš™ï¸" ToolTip="Refresh Settings" Style="{StaticResource RoundedButtonStyle}"
                            Background="#4A5568" Command="{Binding ShowRefreshSettingsCommand}"
                            Width="32" Height="32" Margin="0,0,12,0" FontSize="14"/>
                    <TextBox x:Name="UserSearchBox" Width="250" Height="32"
                             Background="{DynamicResource SurfaceBrush}" Foreground="{DynamicResource PrimaryTextBrush}"
                             BorderBrush="{DynamicResource BorderBrush}" Padding="12,6"
                             FontSize="13" Text="{Binding UserSearchText, UpdateSourceTrigger=PropertyChanged}"
                             behaviors:WatermarkBehavior.Watermark="Search users..."
                             behaviors:VisualFeedbackBehavior.EnableHoverEffect="True"
                             behaviors:VisualFeedbackBehavior.HoverScale="1.02"
                             behaviors:KeyboardNavigationBehavior.EnableEnhancedNavigation="True"/>
                    <Button Content="â˜‘ï¸ Select All" Style="{StaticResource RoundedButtonStyle}" Margin="12,0,0,0" Command="{Binding SelectAllUsersCommand}"/>
                    <Button Content="â˜ Deselect All" Style="{StaticResource RoundedButtonStyle}" Margin="8,0,0,0" Command="{Binding DeselectAllUsersCommand}"/>
                    <Button Content="ðŸ“¤ Export Selected" Style="{StaticResource RoundedButtonStyle}" Margin="8,0,0,0" Command="{Binding ExportSelectedUsersCommand}"/>
                    <Button Content="ðŸ“‹ Copy Selected" Style="{StaticResource RoundedButtonStyle}" Margin="8,0,0,0" Command="{Binding CopySelectedUsersCommand}"/>
                    <Button Content="ðŸ“‹ Copy All" Style="{StaticResource RoundedButtonStyle}" Margin="8,0,0,0" Command="{Binding CopyAllUsersCommand}"/>
                    <Button Content="ðŸ‘ï¸ Columns" Style="{StaticResource RoundedButtonStyle}" Margin="8,0,0,0" Command="{Binding ShowColumnVisibilityCommand}" CommandParameter="users"/>
                    <Button Content="&#x1F50D; Advanced Search" Style="{StaticResource RoundedButtonStyle}" Background="#4299E1" Margin="8,0,0,0" Command="{Binding ShowUsersAdvancedSearchCommand}"/>
                    <Button Content="ðŸ—‘ï¸ Delete Selected" Style="{StaticResource RoundedButtonStyle}" Background="{StaticResource DangerGradient}" Margin="8,0,0,0" Command="{Binding DeleteSelectedUsersCommand}"/>
                </StackPanel>
            </StackPanel>

            <UniformGrid Grid.Row="1" Columns="5" Margin="0,0,0,24">
                <Border Style="{StaticResource MetricCardStyle}">
                    <StackPanel>
                        <TextBlock Text="{Binding Users.Count}" Foreground="{DynamicResource AccentBrush}" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Total Users" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCardStyle}">
                    <StackPanel>
                        <TextBlock Text="{Binding Users.Count}" Foreground="{DynamicResource SuccessBrush}" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Active Users" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCardStyle}">
                    <StackPanel>
                        <TextBlock Text="91" Foreground="#ED8936" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Disabled Users" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCardStyle}">
                    <StackPanel>
                        <TextBlock x:Name="ServiceAccountsTextBlock" Text="0" Foreground="#9F7AEA" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Service Accounts" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCardStyle}">
                    <StackPanel>
                        <TextBlock Text="67" Foreground="#ED8936" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Privileged Users" Foreground="{DynamicResource SecondaryTextBrush}" FontSize="11"/>
                    </StackPanel>
                </Border>
            </UniformGrid>

            <Border Grid.Row="2" Style="{StaticResource ModernCardStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Loading Indicator for Users -->
                    <Border Grid.Row="0" Background="{DynamicResource CardBrush}" Padding="10"
                            Visibility="{Binding IsUsersLoading, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="ðŸ”„" FontSize="16" Margin="0,0,10,0" RenderTransformOrigin="0.5,0.5">
                                <TextBlock.RenderTransform>
                                    <RotateTransform x:Name="LoadingRotation"/>
                                </TextBlock.RenderTransform>
                                <TextBlock.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard RepeatBehavior="Forever">
                                                <DoubleAnimation Storyboard.TargetName="LoadingRotation"
                                                               Storyboard.TargetProperty="Angle"
                                                               From="0" To="360" Duration="0:0:2"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </TextBlock.Triggers>
                            </TextBlock>
                            <StackPanel>
                                <TextBlock Text="{Binding UsersLoadingMessage}" Foreground="#67D391" FontWeight="Medium"/>
                                <ProgressBar Value="{Binding UsersLoadingProgress}" Maximum="100" Width="200" Height="4"
                                           Background="#374151" Foreground="#10B981" Margin="0,5,0,0"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <DataGrid x:Name="UsersDataGrid" Grid.Row="1" ItemsSource="{Binding Users}" Style="{StaticResource ModernDataGridStyle}"
                              CanUserSortColumns="True" AutoGenerateColumns="False" SelectionMode="Extended"
                              VirtualizingStackPanel.IsVirtualizing="True"
                              EnableRowVirtualization="True"
                              EnableColumnVirtualization="True"
                              behaviors:ColumnVisibilityBehavior.GridName="Users"
                              behaviors:VirtualizationBehavior.EnableVirtualization="True"
                              behaviors:VirtualizationBehavior.VirtualizationMode="Recycling"
                              behaviors:VirtualizationBehavior.ScrollUnit="Item"
                              behaviors:VirtualizationBehavior.EnableColumnVirtualization="True"
                              behaviors:VirtualizationBehavior.EnableRowVirtualization="True"
                              behaviors:VisualFeedbackBehavior.EnableHoverEffect="True"
                              behaviors:VisualFeedbackBehavior.EnableLoadingState="True"
                              behaviors:VisualFeedbackBehavior.IsLoading="{Binding IsUsersLoading}"
                              behaviors:KeyboardNavigationBehavior.EnableVirtualizedNavigation="True"
                              behaviors:ResponsiveLayoutBehavior.AdaptiveColumns="True">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="âœ“" Width="40" Binding="{Binding IsSelected, Mode=TwoWay}"/>
                            <DataGridTextColumn Header="Display Name" Binding="{Binding Name}" Width="180" CanUserSort="True" SortMemberPath="Name">
                                <DataGridTextColumn.HeaderStyle>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="Background" Value="{StaticResource PrimaryGradient}"/>
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="Padding" Value="12,8"/>
                                        <Setter Property="HorizontalContentAlignment" Value="Left"/>
                                    </Style>
                                </DataGridTextColumn.HeaderStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="200" CanUserSort="True" SortMemberPath="Email"/>
                            <DataGridTextColumn Header="Department" Binding="{Binding Department}" Width="150" CanUserSort="True" SortMemberPath="Department"/>
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100" CanUserSort="True" SortMemberPath="Status"/>
                            <DataGridTextColumn Header="UPN" Binding="{Binding UserPrincipalName}" Width="200" CanUserSort="True" SortMemberPath="UserPrincipalName"/>
                            <DataGridTextColumn Header="Last Sign-In" Binding="{Binding LastSignInDateTime}" Width="140" CanUserSort="True" SortMemberPath="LastSignInDateTime"/>
                            <DataGridTextColumn Header="Groups" Binding="{Binding GroupMembershipCount}" Width="60" CanUserSort="True" SortMemberPath="GroupMembershipCount"/>
                            <DataGridTextColumn Header="Manager" Binding="{Binding ManagerDisplayName}" Width="150" CanUserSort="True" SortMemberPath="ManagerDisplayName"/>
                            <DataGridTextColumn Header="Job Title" Binding="{Binding JobTitle}" Width="150" CanUserSort="True" SortMemberPath="JobTitle"/>
                            <DataGridTextColumn Header="City" Binding="{Binding City}" Width="120" CanUserSort="True" SortMemberPath="City"/>
                            <DataGridTemplateColumn Header="Actions" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="View"
                                                Background="#4299E1"
                                                Foreground="White"
                                                BorderThickness="0"
                                                Padding="8,4"
                                                FontSize="10"
                                                Command="{Binding ViewUserCommand}"
                                                Tag="{Binding}"
                                                Cursor="Hand"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Empty State Message -->
                    <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Users.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <TextBlock Text="ðŸ“„" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,16" Opacity="0.3"/>
                        <TextBlock Text="No users found"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,8"/>
                        <TextBlock Text="Run a discovery operation to populate user data"
                                   FontSize="14"
                                   Foreground="#718096"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>

                    <!-- Users Pagination Controls -->
                    <Border Grid.Row="2" Background="{DynamicResource SurfaceBrush}" Margin="0,8,0,0" CornerRadius="8" Padding="12,8">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Users.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Page Info -->
                            <TextBlock Grid.Column="0"
                                       Text="{Binding UserPageInfo}"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       VerticalAlignment="Center"
                                       FontSize="13"/>

                            <!-- Page Navigation -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                <!-- First Page Button -->
                                <Button Content="â®ï¸"
                                        Command="{Binding FirstUserPageCommand}"
                                        IsEnabled="{Binding HasPreviousUserPage}"
                                        Style="{StaticResource RoundedButtonStyle}"
                                        Width="32" Height="32"
                                        Margin="0,0,4,0"
                                        ToolTip="First Page"
                                        FontSize="14"/>

                                <!-- Previous Page Button -->
                                <Button Content="â—€ï¸"
                                        Command="{Binding PreviousUserPageCommand}"
                                        IsEnabled="{Binding HasPreviousUserPage}"
                                        Style="{StaticResource RoundedButtonStyle}"
                                        Width="32" Height="32"
                                        Margin="0,0,4,0"
                                        ToolTip="Previous Page"
                                        FontSize="14"/>

                                <!-- Current Page Info -->
                                <Border Background="#4A5568"
                                        CornerRadius="4"
                                        Padding="8,4"
                                        Margin="0,0,4,0">
                                    <TextBlock>
                                        <Run Text="Page "/>
                                        <Run Text="{Binding CurrentUserPage, Mode=OneWay}"/>
                                        <Run Text=" of "/>
                                        <Run Text="{Binding TotalUserPages, Mode=OneWay}"/>
                                    </TextBlock>
                                </Border>

                                <!-- Next Page Button -->
                                <Button Content="â–¶ï¸"
                                        Command="{Binding NextUserPageCommand}"
                                        IsEnabled="{Binding HasNextUserPage}"
                                        Style="{StaticResource RoundedButtonStyle}"
                                        Width="32" Height="32"
                                        Margin="0,0,4,0"
                                        ToolTip="Next Page"
                                        FontSize="14"/>

                                <!-- Last Page Button -->
                                <Button Content="â­ï¸"
                                        Command="{Binding LastUserPageCommand}"
                                        IsEnabled="{Binding HasNextUserPage}"
                                        Style="{StaticResource RoundedButtonStyle}"
                                        Width="32" Height="32"
                                        ToolTip="Last Page"
                                        FontSize="14"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </ScrollViewer>
</UserControl>