"use strict";exports.id=816,exports.ids=[816],exports.modules={816:(e,t,o)=>{o.d(t,{webhookService:()=>a});var s,r=o(982);!function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.FATAL=5]="FATAL"}(s||(s={}));const i=new class{logs=[];config;correlationIdStack=[];performanceMarks=new Map;sessionId;userId;constructor(){this.config={minLevel:s.INFO,maxLogs:1e4,transports:["console"],enablePerformanceLogging:!0,enableStackTrace:!0,rotationSize:10485760,rotationInterval:864e5},this.sessionId=r.randomUUID(),this.loadLogs()}configure(e){this.config={...this.config,...e},console.log("Logging service configured:",this.config)}setLogLevel(e){this.config.minLevel=e}setUserId(e){this.userId=e}startCorrelation(e){const t=e||r.randomUUID();return this.correlationIdStack.push(t),t}endCorrelation(){this.correlationIdStack.pop()}getCurrentCorrelationId(){return this.correlationIdStack[this.correlationIdStack.length-1]}trace(e,t,o){this.log(s.TRACE,e,t,o)}debug(e,t,o){this.log(s.DEBUG,e,t,o)}info(e,t,o){this.log(s.INFO,e,t,o)}warn(e,t,o){this.log(s.WARN,e,t,o)}error(e,t,o,r){const i=r&&this.config.enableStackTrace?{name:r.name,message:r.message,stack:r.stack}:void 0;this.log(s.ERROR,e,t,o,i)}fatal(e,t,o,r){const i=r&&this.config.enableStackTrace?{name:r.name,message:r.message,stack:r.stack}:void 0;this.log(s.FATAL,e,t,o,i)}log(e,t,o,i,n){if(e<this.config.minLevel)return;const a={id:r.randomUUID(),timestamp:new Date,level:e,levelName:s[e],message:t,context:o,correlationId:this.getCurrentCorrelationId(),data:i,error:n,tags:[],userId:this.userId,sessionId:this.sessionId};this.logs.push(a),this.logs.length>this.config.maxLogs&&(this.logs=this.logs.slice(-this.config.maxLogs)),this.outputToTransports(a),this.logs.length%10==0&&this.persistLogs()}startPerformanceMeasure(e){this.config.enablePerformanceLogging&&this.performanceMarks.set(e,performance.now())}endPerformanceMeasure(e,t){if(!this.config.enablePerformanceLogging)return null;const o=this.performanceMarks.get(e);if(!o)return this.warn(`No performance mark found for ${e}`,"Performance"),null;const i=performance.now()-o;this.performanceMarks.delete(e);const n={id:r.randomUUID(),timestamp:new Date,level:s.DEBUG,levelName:"DEBUG",message:`Performance: ${e}`,context:t||"Performance",correlationId:this.getCurrentCorrelationId(),performance:{duration:i,method:e},sessionId:this.sessionId,userId:this.userId};return this.logs.push(n),this.outputToTransports(n),i}async measureAsync(e,t,o){this.startPerformanceMeasure(e);try{return await t()}finally{this.endPerformanceMeasure(e,o)}}outputToTransports(e){for(const t of this.config.transports)switch(t){case"console":this.outputToConsole(e);break;case"file":this.outputToFile(e);break;case"remote":this.outputToRemote(e)}}outputToConsole(e){const t=e.timestamp.toISOString(),o=e.levelName.padEnd(5),r=e.context?`[${e.context}]`:"",i=e.correlationId?`[${e.correlationId.slice(0,8)}]`:"";let n=console.log,a="";switch(e.level){case s.TRACE:n=console.debug,a="[90m";break;case s.DEBUG:n=console.debug,a="[36m";break;case s.INFO:n=console.info,a="[32m";break;case s.WARN:n=console.warn,a="[33m";break;case s.ERROR:n=console.error,a="[31m";break;case s.FATAL:n=console.error,a="[35m"}n(`${a}${t} ${o}[0m ${r}${i} ${e.message}`),e.data&&console.log("  Data:",e.data),e.error&&(console.error("  Error:",e.error.message),e.error.stack&&console.error(e.error.stack)),e.performance&&console.log(`  Duration: ${e.performance.duration.toFixed(2)}ms`)}outputToFile(e){window.electronAPI?.logToFile&&window.electronAPI.logToFile(e).catch(e=>{console.error("Failed to write log to file:",e)})}outputToRemote(e){}getLogs(){return[...this.logs]}filterLogs(e){return this.logs.filter(t=>{if(e.levels&&!e.levels.includes(t.level))return!1;if(e.contexts&&t.context&&!e.contexts.includes(t.context))return!1;if(e.correlationId&&t.correlationId!==e.correlationId)return!1;if(e.startTime&&t.timestamp<e.startTime)return!1;if(e.endTime&&t.timestamp>e.endTime)return!1;if(e.searchText){const o=e.searchText.toLowerCase(),s=t.message.toLowerCase().includes(o),r=t.context?.toLowerCase().includes(o),i=JSON.stringify(t.data||{}).toLowerCase().includes(o);if(!s&&!r&&!i)return!1}if(e.tags&&t.tags){if(!e.tags.some(e=>t.tags.includes(e)))return!1}return!0})}searchLogs(e){return this.filterLogs({searchText:e})}getLogsByCorrelation(e){return this.filterLogs({correlationId:e})}clearLogs(){this.logs=[],localStorage.removeItem("app_logs"),console.log("All logs cleared")}persistLogs(){try{const e=this.logs.slice(-1e3);localStorage.setItem("app_logs",JSON.stringify(e))}catch(e){console.error("Failed to persist logs:",e)}}loadLogs(){try{const e=localStorage.getItem("app_logs");if(e){const t=JSON.parse(e);this.logs=t.map(e=>({...e,timestamp:new Date(e.timestamp)})),console.log(`Loaded ${this.logs.length} persisted logs`)}}catch(e){console.error("Failed to load persisted logs:",e)}}exportLogs(e="json"){let t,o,s;if("json"===e)t=JSON.stringify(this.logs,null,2),o="application/json",s="json";else{t=[["timestamp","level","context","correlationId","message","data"],...this.logs.map(e=>[e.timestamp.toISOString(),e.levelName,e.context||"",e.correlationId||"",e.message,JSON.stringify(e.data||{})])].map(e=>e.map(e=>`"${e}"`).join(",")).join("\n"),o="text/csv",s="csv"}const r=new Blob([t],{type:o}),i=URL.createObjectURL(r),n=document.createElement("a");n.href=i,n.download=`logs_${(new Date).toISOString().replace(/[:.]/g,"-")}.${s}`,n.click(),URL.revokeObjectURL(i),this.info("Logs exported","LoggingService",{format:e,count:this.logs.length})}getStatistics(){const e=this.logs.length,t={};for(let e=s.TRACE;e<=s.FATAL;e++)t[s[e]]=this.logs.filter(t=>t.level===e).length;const o=new Set(this.logs.map(e=>e.context).filter(Boolean)),r=new Set(this.logs.map(e=>e.correlationId).filter(Boolean));return{total:e,byLevel:t,uniqueContexts:o.size,uniqueCorrelations:r.size,sessionId:this.sessionId,userId:this.userId,oldestLog:this.logs[0]?.timestamp,newestLog:this.logs[this.logs.length-1]?.timestamp}}};class n{static instance;webhooks=new Map;deliveries=[];maxDeliveryHistory=1e3;rateLimitMap=new Map;maxRequestsPerMinute=60;constructor(){i.debug("WebhookService instance created","WebhookService")}static getInstance(){return n.instance||(n.instance=new n),n.instance}register(e){this.webhooks.set(e.id,{timeout:3e4,retryCount:3,retryDelay:1e3,...e,enabled:e.enabled??!0}),i.info(`Webhook registered: ${e.name}`,"WebhookService",{id:e.id,url:e.url,events:e.events})}unregister(e){const t=this.webhooks.delete(e);return t&&i.info(`Webhook unregistered: ${e}`,"WebhookService"),t}getWebhook(e){return this.webhooks.get(e)}getAllWebhooks(){return Array.from(this.webhooks.values())}update(e,t){const o=this.webhooks.get(e);return!!o&&(this.webhooks.set(e,{...o,...t,id:e}),i.info(`Webhook updated: ${e}`,"WebhookService"),!0)}enable(e){return this.update(e,{enabled:!0})}disable(e){return this.update(e,{enabled:!1})}async trigger(e,t,o){const s=this.getWebhooksForEvent(e);if(0===s.length)return void i.debug(`No webhooks registered for event: ${e}`,"WebhookService");const r={event:e,timestamp:(new Date).toISOString(),data:t,metadata:o},n=s.map(e=>this.deliver(e,r));await Promise.allSettled(n)}getWebhooksForEvent(e){return Array.from(this.webhooks.values()).filter(t=>t.enabled&&(t.events.includes(e)||t.events.includes("*")))}async deliver(e,t,o=1){if(!this.checkRateLimit(e.id))return void i.warn(`Rate limit exceeded for webhook: ${e.id}`,"WebhookService");const s={id:this.generateDeliveryId(),webhookId:e.id,event:t.event,payload:t,url:e.url,status:"pending",attempt:o,maxAttempts:e.retryCount||3,sentAt:new Date};this.addDelivery(s);try{const o=performance.now(),r={"Content-Type":"application/json","User-Agent":"MandA-Discovery-Suite/1.0",...e.headers};e.secret&&(r["X-Webhook-Signature"]=this.generateSignature(t,e.secret));const n=new AbortController,a=setTimeout(()=>n.abort(),e.timeout||3e4),l=await fetch(e.url,{method:"POST",headers:r,body:JSON.stringify(t),signal:n.signal});clearTimeout(a);const c=performance.now()-o,h=await l.text();if(s.status=l.ok?"success":"failed",s.httpStatus=l.status,s.completedAt=new Date,s.responseBody=h.substring(0,1e3),s.responseTime=c,!l.ok)throw s.error=`HTTP ${l.status}: ${l.statusText}`,new Error(s.error);i.info(`Webhook delivered successfully: ${e.name}`,"WebhookService",{event:t.event,responseTime:`${c.toFixed(2)}ms`,status:l.status})}catch(r){if(s.status="failed",s.error=r instanceof Error?r.message:String(r),s.completedAt=new Date,i.error(`Webhook delivery failed: ${e.name}`,"WebhookService",{event:t.event,attempt:o,error:r instanceof Error?r.message:String(r)}),o<(e.retryCount||3)){const s=this.calculateRetryDelay(o,e.retryDelay||1e3);i.info(`Retrying webhook in ${s}ms`,"WebhookService",{attempt:o+1}),await this.sleep(s),await this.deliver(e,t,o+1)}}}calculateRetryDelay(e,t){return t*Math.pow(2,e-1)}sleep(e){return new Promise(t=>setTimeout(t,e))}checkRateLimit(e){const t=Date.now(),o=t-6e4,s=(this.rateLimitMap.get(e)||[]).filter(e=>e>o);return!(s.length>=this.maxRequestsPerMinute)&&(s.push(t),this.rateLimitMap.set(e,s),!0)}generateSignature(e,t){const o=JSON.stringify(e);return btoa(`${t}.${o}`)}verifySignature(e,t,o){return t===this.generateSignature(e,o)}async test(e){const t=this.webhooks.get(e);if(!t)throw new Error(`Webhook not found: ${e}`);const o={event:"test",timestamp:(new Date).toISOString(),data:{message:"This is a test webhook delivery"},metadata:{test:!0}};await this.deliver(t,o);const s=this.getDeliveriesForWebhook(e);return s[s.length-1]}generateDeliveryId(){return`delivery-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}addDelivery(e){this.deliveries.push(e),this.deliveries.length>this.maxDeliveryHistory&&this.deliveries.shift()}getDeliveriesForWebhook(e){return this.deliveries.filter(t=>t.webhookId===e)}getAllDeliveries(){return[...this.deliveries]}getDelivery(e){return this.deliveries.find(t=>t.id===e)}getStats(e){const t=this.getDeliveriesForWebhook(e),o=t.filter(e=>"success"===e.status),s=t.filter(e=>"failed"===e.status),r=o.reduce((e,t)=>e+(t.responseTime||0),0),i=o.length>0?r/o.length:0,n=t.length>0?t[t.length-1].sentAt:void 0,a=t.length>0?o.length/t.length:0;return{webhookId:e,totalDeliveries:t.length,successfulDeliveries:o.length,failedDeliveries:s.length,averageResponseTime:i,lastDelivery:n,successRate:a}}clearDeliveries(){this.deliveries=[],i.info("Webhook delivery history cleared","WebhookService")}exportWebhooks(){const e=this.getAllWebhooks();return JSON.stringify(e,null,2)}importWebhooks(e){try{const t=JSON.parse(e);let o=0;for(const e of t)this.register(e),o++;return i.info(`Imported ${o} webhooks`,"WebhookService"),o}catch(e){throw i.error("Failed to import webhooks","WebhookService",e),e}}setRateLimit(e){this.maxRequestsPerMinute=e,i.info(`Webhook rate limit set to ${e} requests/minute`,"WebhookService")}getRateLimit(){return this.maxRequestsPerMinute}}const a=n.getInstance()}};