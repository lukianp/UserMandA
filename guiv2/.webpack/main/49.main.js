"use strict";exports.id=49,exports.ids=[49],exports.modules={49:(e,t,s)=>{s.d(t,{getFileWatcherService:()=>n});var i=s(434),a=s(943),r=s(896),c=s(928);class o extends i.EventEmitter{config;watchers=new Map;mainWindow=null;statistics={activeWatchers:0,watchedDirectories:[],totalEvents:0,eventsByType:{added:0,changed:0,deleted:0}};debounceTimers=new Map;fileStates=new Map;constructor(e={}){super(),this.config={baseDataPath:e.baseDataPath||"C:\\discoverydata",debounceDelay:e.debounceDelay||300,watchExtensions:e.watchExtensions||[".csv",".json",".log",".txt"]}}setMainWindow(e){this.mainWindow=e}async watchProfile(e){this.watchers.has(e)&&await this.stopWatching(e);const t=c.join(this.config.baseDataPath,e,"Raw"),s=c.join(this.config.baseDataPath,e,"Logs");await this.ensureDirectories(t,s);const i={profileId:e,rawWatcher:null,logsWatcher:null,rawPath:t,logsPath:s};try{i.rawWatcher=this.createWatcher(t,e,"raw"),i.logsWatcher=this.createWatcher(s,e,"logs"),this.watchers.set(e,i),this.statistics.activeWatchers=this.watchers.size,this.updateWatchedDirectories(),console.log(`FileWatcherService: Started watching profile "${e}"`),console.log(`  Raw: ${t}`),console.log(`  Logs: ${s}`)}catch(t){throw console.error(`FileWatcherService: Failed to watch profile "${e}":`,t.message),i.rawWatcher&&i.rawWatcher.close(),i.logsWatcher&&i.logsWatcher.close(),t}}async stopWatching(e){const t=this.watchers.get(e);if(!t)return void console.warn(`FileWatcherService: No watcher found for profile "${e}"`);t.rawWatcher&&t.rawWatcher.close(),t.logsWatcher&&t.logsWatcher.close();Array.from(this.debounceTimers.keys()).filter(t=>t.startsWith(`${e}:`)).forEach(e=>{const t=this.debounceTimers.get(e);t&&(clearTimeout(t),this.debounceTimers.delete(e))});Array.from(this.fileStates.keys()).filter(t=>t.startsWith(`${e}:`)).forEach(e=>{this.fileStates.delete(e)}),this.watchers.delete(e),this.statistics.activeWatchers=this.watchers.size,this.updateWatchedDirectories(),console.log(`FileWatcherService: Stopped watching profile "${e}"`)}async stopAll(){const e=Array.from(this.watchers.keys());for(const t of e)await this.stopWatching(t);console.log("FileWatcherService: Stopped all watchers")}getWatchedFiles(){const e=[];for(const t of this.watchers.values())try{const s=r.readdirSync(t.rawPath).filter(e=>this.shouldWatch(e)).map(e=>c.join(t.rawPath,e)),i=r.readdirSync(t.logsPath).filter(e=>this.shouldWatch(e)).map(e=>c.join(t.logsPath,e));e.push(...s,...i)}catch(e){console.warn(`FileWatcherService: Cannot list files for profile "${t.profileId}"`)}return e}getStatistics(){return{...this.statistics}}createWatcher(e,t,s){const i=r.watch(e,{persistent:!0,recursive:!1},(i,a)=>{if(!a)return;if(!this.shouldWatch(a))return;const r=c.join(e,a),o=`${t}:${s}:${a}`;this.debounceEvent(o,()=>{this.handleFileChange(i,r,t,s,a)})});return i.on("error",i=>{console.error(`FileWatcherService: Watcher error for ${e}:`,i),this.emit("error",{profileId:t,directory:s,error:i})}),i}async handleFileChange(e,t,s,i,r){const o=`${s}:${i}:${r}`;let h;try{const e=await a.stat(t),n={size:e.size,mtime:e.mtimeMs},l=this.fileStates.get(o);if(l){if(l.size===n.size&&l.mtime===n.mtime)return;h="changed",this.statistics.eventsByType.changed++}else h="added",this.statistics.eventsByType.added++;this.fileStates.set(o,n);const d={type:h,filePath:t,fileName:r,directory:i,profileId:s,timestamp:new Date,fileSize:e.size,extension:c.extname(r)};this.emitChangeEvent(d)}catch(e){if("ENOENT"===e.code){h="deleted",this.statistics.eventsByType.deleted++,this.fileStates.delete(o);const e={type:"deleted",filePath:t,fileName:r,directory:i,profileId:s,timestamp:new Date};this.emitChangeEvent(e)}else console.error("FileWatcherService: Error handling file change:",e)}}emitChangeEvent(e){this.statistics.totalEvents++,this.statistics.lastEventTimestamp=e.timestamp,this.emit("fileChanged",e),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("file:changed",e),console.log(`FileWatcherService: ${e.type.toUpperCase()} - ${e.fileName} (${e.directory})`)}debounceEvent(e,t){const s=this.debounceTimers.get(e);s&&clearTimeout(s);const i=setTimeout(()=>{t(),this.debounceTimers.delete(e)},this.config.debounceDelay);this.debounceTimers.set(e,i)}shouldWatch(e){const t=c.extname(e).toLowerCase();return this.config.watchExtensions.includes(t)}async ensureDirectories(e,t){try{await a.mkdir(e,{recursive:!0}),await a.mkdir(t,{recursive:!0})}catch(e){throw console.error("FileWatcherService: Failed to create directories:",e.message),e}}updateWatchedDirectories(){const e=[];for(const t of this.watchers.values())e.push(t.rawPath,t.logsPath);this.statistics.watchedDirectories=e}}let h=null;function n(e){return h||(h=new o(e)),h}}};