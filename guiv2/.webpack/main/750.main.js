"use strict";exports.id=750,exports.ids=[750],exports.modules={750:(e,r,t)=>{t.d(r,{registerTargetProfileHandlers:()=>y});var o=t(482),n=t(928),i=t(896),a=t(317);function c(){const e=o.app.getPath("userData"),r=n.join(e,"profiles");return i.existsSync(r)||i.mkdirSync(r,{recursive:!0}),n.join(r,"target-profiles.json")}async function l(){try{const e=c();if(!i.existsSync(e))return console.log("[TargetProfileService] No target profiles file found, returning empty array"),[];const r=await i.promises.readFile(e,"utf8"),t=JSON.parse(r);return console.log(`[TargetProfileService] Loaded ${t.length} target profiles`),t}catch(e){return console.error("[TargetProfileService] Failed to load target profiles:",e),[]}}async function s(e){try{const r=c(),t=JSON.stringify(e,null,2);await i.promises.writeFile(r,t,"utf8"),console.log(`[TargetProfileService] Saved ${e.length} target profiles`)}catch(e){throw console.error("[TargetProfileService] Failed to save target profiles:",e),e}}async function g(e){try{const r=await l();if(r.find(r=>r.name===e.name))return{success:!1,error:`A target profile with the name "${e.name}" already exists`};const t={...e,id:e.id||crypto.randomUUID(),createdAt:(new Date).toISOString(),created:(new Date).toISOString(),lastModified:(new Date).toISOString(),isActive:!1,isConnected:!1};if(t.clientSecret&&t.companyName){await u(t.companyName,t.clientSecret)&&(t.clientSecret=`[encrypted:${t.companyName}]`)}return r.push(t),await s(r),console.log(`[TargetProfileService] Created target profile: ${t.name}`),{success:!0,profile:t}}catch(e){return console.error("[TargetProfileService] Failed to create target profile:",e),{success:!1,error:e.message||"Failed to create target profile"}}}async function f(e,r){try{const t=await l(),o=t.findIndex(r=>r.id===e);if(-1===o)return{success:!1,error:`Target profile with ID "${e}" not found`};if(r.clientSecret&&t[o].companyName){await u(t[o].companyName,r.clientSecret)&&(r.clientSecret=`[encrypted:${t[o].companyName}]`)}const n={...t[o],...r,lastModified:(new Date).toISOString()};return t[o]=n,await s(t),console.log(`[TargetProfileService] Updated target profile: ${e}`),{success:!0,profile:n}}catch(e){return console.error("[TargetProfileService] Failed to update target profile:",e),{success:!1,error:e.message||"Failed to update target profile"}}}async function p(e){try{const r=await l(),t=r.findIndex(r=>r.id===e);if(-1===t)return{success:!1,error:`Target profile with ID "${e}" not found`};const o=r[t];return r.splice(t,1),await s(r),console.log(`[TargetProfileService] Deleted target profile: ${e}`),{success:!0,profile:o}}catch(e){return console.error("[TargetProfileService] Failed to delete target profile:",e),{success:!1,error:e.message||"Failed to delete target profile"}}}async function d(e){try{const r=await l();r.forEach(e=>{e.isActive=!1});const t=r.find(r=>r.id===e);return t?(t.isActive=!0,await s(r),console.log(`[TargetProfileService] Set active target profile: ${t.name}`),{success:!0,profile:t}):{success:!1,error:`Target profile with ID "${e}" not found`}}catch(e){return console.error("[TargetProfileService] Failed to set active target profile:",e),{success:!1,error:e.message||"Failed to set active target profile"}}}async function u(e,r){try{const t=n.join("C:","DiscoveryData",e,"Credentials");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const o=n.join(t,"target-credential.enc"),c=`\n      try {\n        $plaintext = '${r.replace(/'/g,"''")}'\n        $ss = ConvertTo-SecureString -String $plaintext -AsPlainText -Force\n        $encrypted = ConvertFrom-SecureString -SecureString $ss\n        Set-Content -Path '${o.replace(/'/g,"''")}' -Value $encrypted\n        Write-Output "SUCCESS"\n      } catch {\n        Write-Error $_.Exception.Message\n        exit 1\n      }\n    `;return new Promise(e=>{const r=(0,a.spawn)("powershell.exe",["-NoProfile","-ExecutionPolicy","Bypass","-Command",c]);let t="",n="";r.stdout?.on("data",e=>{t+=e.toString()}),r.stderr?.on("data",e=>{n+=e.toString()}),r.on("close",r=>{0===r&&"SUCCESS"===t.trim()?e(o):(console.error("[TargetProfileService] Encryption failed:",n),e(null))}),r.on("error",r=>{console.error("[TargetProfileService] PowerShell execution failed:",r),e(null)})})}catch(e){return console.error("[TargetProfileService] Encryption error:",e),null}}async function S(e){try{const r=n.join("C:","DiscoveryData",e,"Credentials","target-credential.enc");if(!i.existsSync(r))return console.error(`[TargetProfileService] Credential file not found: ${r}`),null;const t=`\n      try {\n        $encrypted = Get-Content -Path '${r.replace(/'/g,"''")}' -Raw\n        $ss = ConvertTo-SecureString -String $encrypted\n        $bstr = [Runtime.InteropServices.Marshal]::SecureStringToBSTR($ss)\n        $plaintext = [Runtime.InteropServices.Marshal]::PtrToStringUni($bstr)\n        [Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)\n        Write-Output $plaintext\n      } catch {\n        Write-Error $_.Exception.Message\n        exit 1\n      }\n    `;return new Promise(e=>{const r=(0,a.spawn)("powershell.exe",["-NoProfile","-ExecutionPolicy","Bypass","-Command",t]);let o="",n="";r.stdout?.on("data",e=>{o+=e.toString()}),r.stderr?.on("data",e=>{n+=e.toString()}),r.on("close",r=>{0===r&&o.trim()?e(o.trim()):(console.error("[TargetProfileService] Decryption failed:",n),e(null))}),r.on("error",r=>{console.error("[TargetProfileService] PowerShell execution failed:",r),e(null)})})}catch(e){return console.error("[TargetProfileService] Decryption error:",e),null}}function y(){o.ipcMain.handle("profile:loadTargetProfiles",async e=>(console.log("[IPC] profile:loadTargetProfiles"),await l())),o.ipcMain.handle("profile:createTarget",async(e,r)=>(console.log("[IPC] profile:createTarget",r.name),await g(r))),o.ipcMain.handle("profile:updateTarget",async(e,r,t)=>(console.log("[IPC] profile:updateTarget",r),await f(r,t))),o.ipcMain.handle("profile:deleteTarget",async(e,r)=>(console.log("[IPC] profile:deleteTarget",r),await p(r))),o.ipcMain.handle("profile:setActiveTarget",async(e,r)=>(console.log("[IPC] profile:setActiveTarget",r),await d(r))),o.ipcMain.handle("profile:decryptTargetCredential",async(e,r)=>(console.log("[IPC] profile:decryptTargetCredential",r),await S(r))),console.log("[IPC] Target profile handlers registered")}}};