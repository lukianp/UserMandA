"use strict";exports.id=224,exports.ids=[224],exports.modules={224:(e,t,n)=>{n.d(t,{registerConnectionTestHandlers:()=>l});var s=n(482),o=n(317),r=n(434);class i extends r.EventEmitter{activeTests=new Map;async testActiveDirectory(e,t){const n=Date.now();try{console.log(`[ConnectionTest] Testing Active Directory: ${e}`);const t='\n        param($DomainController)\n\n        try {\n          $startTime = Get-Date\n\n          # Test 1: DNS Resolution\n          $resolved = Resolve-DnsName -Name $DomainController -ErrorAction Stop\n\n          # Test 2: LDAP Port (389)\n          $tcpClient = New-Object System.Net.Sockets.TcpClient\n          $connectTask = $tcpClient.ConnectAsync($DomainController, 389)\n          $timeout = [System.Threading.Tasks.Task]::Delay(5000)\n          $completed = [System.Threading.Tasks.Task]::WaitAny(@($connectTask, $timeout))\n\n          if ($completed -eq 0 -and $tcpClient.Connected) {\n            $tcpClient.Close()\n\n            # Test 3: Get Domain Info\n            $domain = Get-ADDomain -Server $DomainController -ErrorAction Stop\n\n            $responseTime = ((Get-Date) - $startTime).TotalMilliseconds\n\n            $result = @{\n              Success = $true\n              Available = $true\n              ResponseTime = $responseTime\n              Version = $domain.DomainMode\n              Details = @{\n                DomainName = $domain.DNSRoot\n                NetBiosName = $domain.NetBIOSName\n                ForestName = $domain.Forest\n                DomainControllers = @($domain.ReplicaDirectoryServers)\n              }\n            }\n\n            Write-Output (ConvertTo-Json $result -Depth 10 -Compress)\n          } else {\n            throw "Connection timeout or failed"\n          }\n        } catch {\n          $result = @{\n            Success = $false\n            Available = $false\n            Error = $_.Exception.Message\n          }\n          Write-Output (ConvertTo-Json $result -Compress)\n        }\n      ';return{serviceType:"ActiveDirectory",...await this.executePowerShellScript(t,{DomainController:e}),responseTime:Date.now()-n}}catch(e){return{success:!1,serviceType:"ActiveDirectory",available:!1,error:e.message,responseTime:Date.now()-n}}}async testExchangeServer(e,t){const n=Date.now();try{console.log(`[ConnectionTest] Testing Exchange Server: ${e}`);const t='\n        param($ServerUrl)\n\n        try {\n          $startTime = Get-Date\n\n          # Test connection to Exchange Web Services\n          $uri = New-Object Uri($ServerUrl)\n          $tcpClient = New-Object System.Net.Sockets.TcpClient\n          $connectTask = $tcpClient.ConnectAsync($uri.Host, $uri.Port)\n          $timeout = [System.Threading.Tasks.Task]::Delay(5000)\n          $completed = [System.Threading.Tasks.Task]::WaitAny(@($connectTask, $timeout))\n\n          if ($completed -eq 0 -and $tcpClient.Connected) {\n            $tcpClient.Close()\n\n            $responseTime = ((Get-Date) - $startTime).TotalMilliseconds\n\n            $result = @{\n              Success = $true\n              Available = $true\n              ResponseTime = $responseTime\n              Details = @{\n                ServerUrl = $ServerUrl\n                Host = $uri.Host\n                Port = $uri.Port\n              }\n            }\n\n            Write-Output (ConvertTo-Json $result -Compress)\n          } else {\n            throw "Connection timeout or failed"\n          }\n        } catch {\n          $result = @{\n            Success = $false\n            Available = $false\n            Error = $_.Exception.Message\n          }\n          Write-Output (ConvertTo-Json $result -Compress)\n        }\n      ';return{serviceType:"Exchange",...await this.executePowerShellScript(t,{ServerUrl:e}),responseTime:Date.now()-n}}catch(e){return{success:!1,serviceType:"Exchange",available:!1,error:e.message,responseTime:Date.now()-n}}}async testAzureAD(e,t,n){const s=Date.now();try{console.log(`[ConnectionTest] Testing Azure AD: ${e}`);const o="\n        param($TenantId, $ClientId, $ClientSecret)\n\n        try {\n          $startTime = Get-Date\n\n          # Get access token\n          $body = @{\n            grant_type    = 'client_credentials'\n            client_id     = $ClientId\n            client_secret = $ClientSecret\n            scope         = 'https://graph.microsoft.com/.default'\n          }\n\n          $tokenUrl = \"https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token\"\n          $tokenResponse = Invoke-RestMethod -Method Post -Uri $tokenUrl -Body $body -ContentType 'application/x-www-form-urlencoded'\n\n          # Test Graph API\n          $headers = @{\n            Authorization = \"Bearer $($tokenResponse.access_token)\"\n          }\n\n          $orgResponse = Invoke-RestMethod -Method Get -Uri 'https://graph.microsoft.com/v1.0/organization' -Headers $headers\n\n          $responseTime = ((Get-Date) - $startTime).TotalMilliseconds\n\n          $result = @{\n            Success = $true\n            Available = $true\n            ResponseTime = $responseTime\n            Details = @{\n              TenantId = $orgResponse.value[0].id\n              DisplayName = $orgResponse.value[0].displayName\n              TenantType = $orgResponse.value[0].tenantType\n              VerifiedDomains = @($orgResponse.value[0].verifiedDomains.name)\n            }\n          }\n\n          Write-Output (ConvertTo-Json $result -Depth 10 -Compress)\n        } catch {\n          $result = @{\n            Success = $false\n            Available = $false\n            Error = $_.Exception.Message\n          }\n          Write-Output (ConvertTo-Json $result -Compress)\n        }\n      ";return{serviceType:"AzureAD",...await this.executePowerShellScript(o,{TenantId:e,ClientId:t,ClientSecret:n}),responseTime:Date.now()-s}}catch(e){return{success:!1,serviceType:"AzureAD",available:!1,error:e.message,responseTime:Date.now()-s}}}async testEnvironment(e){const t=`test-${Date.now()}`;this.activeTests.set(t,!0);try{console.log(`[ConnectionTest] Starting environment test: ${t}`),this.emit("test:started",{testId:t,profileName:e.profileName});const n=[],s=[];if(e.domainController){this.emit("test:progress",{testId:t,service:"ActiveDirectory",status:"testing"});const o=await this.testActiveDirectory(e.domainController,e.credential);n.push(o),o.success&&(s.push("ActiveDirectory"),s.push("UserDiscovery"),s.push("GroupDiscovery"),s.push("ComputerDiscovery"))}if(e.exchangeServer){this.emit("test:progress",{testId:t,service:"Exchange",status:"testing"});const o=await this.testExchangeServer(e.exchangeServer,e.credential);n.push(o),o.success&&(s.push("Exchange"),s.push("MailboxDiscovery"))}if(e.tenantId&&e.clientId&&e.clientSecret){this.emit("test:progress",{testId:t,service:"AzureAD",status:"testing"});const o=await this.testAzureAD(e.tenantId,e.clientId,e.clientSecret);n.push(o),o.success&&(s.push("AzureAD"),s.push("CloudUserDiscovery"),s.push("AzureResourceDiscovery"))}const o=[],r=n.filter(e=>!e.success);r.length>0&&o.push(`${r.length} service(s) failed connectivity tests. Review credentials and network configuration.`),s.includes("ActiveDirectory")&&!s.includes("Exchange")&&o.push("Consider adding Exchange Server for mailbox discovery."),s.includes("ActiveDirectory")&&!s.includes("AzureAD")&&o.push("Consider adding Azure AD for hybrid environment discovery.");const i={testId:t,profileName:e.profileName,timestamp:(new Date).toISOString(),overallSuccess:n.every(e=>e.success),tests:n,capabilities:s,recommendations:o};return this.emit("test:completed",i),this.activeTests.delete(t),i}catch(e){throw this.emit("test:failed",{testId:t,error:e.message}),this.activeTests.delete(t),e}}async executePowerShellScript(e,t){return new Promise((n,s)=>{const r=["-NoProfile","-ExecutionPolicy","Bypass","-Command",e];Object.entries(t).forEach(([e,t])=>{r.push("-"+e),r.push(String(t))});const i=(0,o.spawn)("powershell.exe",r,{shell:!0,stdio:["ignore","pipe","pipe"]});let c="",a="";i.stdout?.on("data",e=>{c+=e.toString()}),i.stderr?.on("data",e=>{a+=e.toString()}),i.on("close",e=>{if(0===e&&c.trim())try{const e=JSON.parse(c.trim());n(e)}catch(e){s(new Error(`Failed to parse PowerShell output: ${c}`))}else s(new Error(a||`PowerShell exited with code ${e}`))}),i.on("error",e=>{s(e)})})}async cancelTest(e){return!!this.activeTests.has(e)&&(this.activeTests.delete(e),this.emit("test:cancelled",{testId:e}),!0)}getStatistics(){return{activeTests:this.activeTests.size,testIds:Array.from(this.activeTests.keys())}}}let c=null;let a=null;function l(e){e&&(a=e);const t=(c||(c=new i),c);a&&(t.on("test:started",e=>{a?.webContents.send("connection-test:started",e)}),t.on("test:progress",e=>{a?.webContents.send("connection-test:progress",e)}),t.on("test:completed",e=>{a?.webContents.send("connection-test:completed",e)}),t.on("test:failed",e=>{a?.webContents.send("connection-test:failed",e)}),t.on("test:cancelled",e=>{a?.webContents.send("connection-test:cancelled",e)})),s.ipcMain.handle("connection-test:active-directory",async(e,n,s)=>(console.log("[IPC] connection-test:active-directory",n),await t.testActiveDirectory(n,s))),s.ipcMain.handle("connection-test:exchange",async(e,n,s)=>(console.log("[IPC] connection-test:exchange",n),await t.testExchangeServer(n,s))),s.ipcMain.handle("connection-test:azure-ad",async(e,n,s,o)=>(console.log("[IPC] connection-test:azure-ad",n),await t.testAzureAD(n,s,o))),s.ipcMain.handle("connection-test:environment",async(e,n)=>(console.log("[IPC] connection-test:environment",n.profileName),await t.testEnvironment(n))),s.ipcMain.handle("connection-test:cancel",async(e,n)=>(console.log("[IPC] connection-test:cancel",n),await t.cancelTest(n))),s.ipcMain.handle("connection-test:statistics",async e=>(console.log("[IPC] connection-test:statistics"),t.getStatistics())),console.log("[IPC] Connection test handlers registered")}}};