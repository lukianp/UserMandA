"use strict";exports.id="src_main_ipc_appRegistrationHandlers_ts",exports.ids=["src_main_ipc_appRegistrationHandlers_ts"],exports.modules={"./src/main/ipc/appRegistrationHandlers.ts":(e,t,s)=>{s.d(t,{registerAppRegistrationHandlers:()=>n});var r=s("electron"),i=s("./src/main/services/appRegistrationService.ts");function n(){r.ipcMain.handle("app-registration:launch",async(e,t)=>(console.log("[IPC] app-registration:launch",t),await i.launchAppRegistration(t))),r.ipcMain.handle("app-registration:has-credentials",async(e,t)=>(console.log("[IPC] app-registration:has-credentials",t),i.hasAppRegistrationCredentials(t))),r.ipcMain.handle("app-registration:read-summary",async(e,t)=>{console.log("[IPC] app-registration:read-summary",t);try{return await i.readCredentialSummary(t)}catch(e){return console.error("[IPC] app-registration:read-summary error:",e.message),null}}),r.ipcMain.handle("app-registration:decrypt-credential",async(e,t)=>(console.log("[IPC] app-registration:decrypt-credential",t),await i.decryptCredentialFile(t))),r.ipcMain.handle("app-registration:read-status",async(e,t)=>{const s=await i.readRegistrationStatus(t);return s&&console.log("[IPC] app-registration:read-status",t,"=> status:",s.status,"step:",s.step,"progress:",s.progress,"%"),s}),r.ipcMain.handle("app-registration:clear-status",async(e,t)=>(console.log("[IPC] app-registration:clear-status",t),await i.clearRegistrationStatus(t))),r.ipcMain.on("app-registration:broadcast-status",(e,t)=>{console.log("[IPC] app-registration:broadcast-status",t.step,t.message);const s=r.BrowserWindow.getAllWindows();for(const e of s)e.isDestroyed()||e.webContents.send("app-registration:status-update",t)}),console.log("[IPC] App registration handlers registered with streaming support")}},"./src/main/services/appRegistrationService.ts":(e,t,s)=>{s.d(t,{clearRegistrationStatus:()=>R,decryptCredentialFile:()=>y,hasAppRegistrationCredentials:()=>f,launchAppRegistration:()=>S,readCredentialSummary:()=>C,readRegistrationStatus:()=>A});var r=s("child_process"),i=s("path"),n=s("fs"),o=s("electron");const a=["Initialization","Prerequisites","ModuleManagement","GraphConnection","AzureConnection","AppRegistration","PermissionGrant","RoleAssignment","SubscriptionAccess","SecretCreation","CredentialStorage","Complete"];function c(e){const t={Prerequisites:"Prerequisites",ModuleManagement:"ModuleManagement","Module Management":"ModuleManagement",GraphConnection:"GraphConnection","Graph Connection":"GraphConnection","Microsoft Graph":"GraphConnection",AzureConnection:"AzureConnection","Azure Connection":"AzureConnection","Azure Login":"AzureConnection",AppRegistration:"AppRegistration","App Registration":"AppRegistration","Application Registration":"AppRegistration",PermissionGrant:"PermissionGrant","Permission Grant":"PermissionGrant","Admin Consent":"PermissionGrant",RoleAssignment:"RoleAssignment","Role Assignment":"RoleAssignment","Directory Roles":"RoleAssignment",SubscriptionAccess:"SubscriptionAccess","Subscription Access":"SubscriptionAccess","Azure Subscriptions":"SubscriptionAccess",SecretCreation:"SecretCreation","Secret Creation":"SecretCreation","Client Secret":"SecretCreation",CredentialStorage:"CredentialStorage","Credential Storage":"CredentialStorage","Credential Encryption":"CredentialStorage",Complete:"Complete",Completed:"Complete",Success:"Complete"};if(t[e])return t[e];const s=e.toLowerCase();for(const[e,r]of Object.entries(t))if(e.toLowerCase()===s)return r;for(const[e,r]of Object.entries(t))if(s.includes(e.toLowerCase())||e.toLowerCase().includes(s))return r;return"Initialization"}function l(e,t=!1){const s=a.indexOf(e);if(-1===s)return 0;const r=Math.round((s+1)/a.length*100);return t?Math.max(0,r-5):r}function p(e){const t=e.toLowerCase();return t.includes("prerequisite")||t.includes("validat")?"Prerequisites":t.includes("module")||t.includes("install")?"ModuleManagement":t.includes("graph")||t.includes("microsoft.graph")?"GraphConnection":t.includes("azure")&&(t.includes("connect")||t.includes("login"))?"AzureConnection":t.includes("app")&&t.includes("regist")?"AppRegistration":t.includes("permission")||t.includes("consent")?"PermissionGrant":t.includes("role")||t.includes("directory")?"RoleAssignment":t.includes("subscription")?"SubscriptionAccess":t.includes("secret")||t.includes("credential")?"SecretCreation":t.includes("encrypt")||t.includes("storage")||t.includes("saving")?"CredentialStorage":t.includes("complete")||t.includes("success")||t.includes("finished")?"Complete":"Initialization"}function u(e){if(!e||0===e.trim().length)return null;let t;const s=(new Date).toISOString();if(t=/^\[COMPLETED\]\s+\[([^\]]+)\]\s*\[SUCCESS\]\s*\[OK\]\s*(.+?)\s*(?:\([^)]*?([\d.]+)s\))?$/i.exec(e)){const[,e,r,i]=t,n=c(r.trim());return{status:"completed",step:n,message:`${r.trim()} completed${i?` in ${i}s`:""}`,progress:l(n),timestamp:e||s}}if(t=/^\[IN PROGRESS\]\s+\[([^\]]+)\]\s*\[PROGRESS\]\s*(.+)$/i.exec(e)){const[,e,r]=t,i=p(r);return{status:"in_progress",step:i,message:r.trim(),progress:l(i,!0),timestamp:e||s}}if(t=/^\[FAILED\]\s+\[([^\]]+)\]\s*\[(?:ERROR|CRITICAL)\]\s*(.+)$/i.exec(e)){const[,e,r]=t;return{status:"failed",step:"Error",message:"Operation failed",progress:0,timestamp:e||s,error:r.trim()}}if(t=/^\[OK\]\s+(.+?)\s*(?:\([^)]*?([\d.]+)s\))?$/i.exec(e)){const[,e,r]=t,i=c(e.trim());return{status:"completed",step:i,message:`${e.trim()} completed${r?` in ${r}s`:""}`,progress:l(i),timestamp:s}}if(t=/^(?:\[PROGRESS\]|Starting:?)\s*(.+)$/i.exec(e)){const[,e]=t,r=p(e);return{status:"in_progress",step:r,message:e.trim(),progress:l(r,!0),timestamp:s}}if(t=/^(?:\[ERROR\]|\[CRITICAL\]|Error:)\s*(.+)$/i.exec(e)){const[,e]=t;return{status:"failed",step:"Error",message:"Error occurred",progress:0,timestamp:s,error:e.trim()}}return null}function d(e){return i.join("C:","DiscoveryData",e,"Logs","MandADiscovery_Registration_Log_status.json")}async function g(e,t){try{const s=d(e),r=i.dirname(s);await n.promises.mkdir(r,{recursive:!0});const o={status:"completed"===t.status&&"Complete"===t.step?"success":"failed"===t.status?"failed":"running",message:t.message,error:t.error||"",step:t.step,timestamp:t.timestamp,logFile:i.join("C:","DiscoveryData",e,"Logs","MandADiscovery_Registration_Log.txt"),progress:t.progress};await n.promises.writeFile(s,JSON.stringify(o,null,2)),console.log(`[AppRegistrationService] Status update written: ${t.step} - ${t.message}`)}catch(e){console.error("[AppRegistrationService] Failed to write status file:",e)}}function m(e){try{const t=o.BrowserWindow.getAllWindows();for(const s of t)s.isDestroyed()||s.webContents.send("app-registration:status-update",e)}catch(e){console.error("[AppRegistrationService] Failed to broadcast status:",e)}}async function S(e){try{const t=function(){const e=[i.join(o.app.getAppPath(),"..","..","Scripts","DiscoveryCreateAppRegistration.ps1"),i.join(process.resourcesPath,"Scripts","DiscoveryCreateAppRegistration.ps1"),i.join("C:","enterprisediscovery","Scripts","DiscoveryCreateAppRegistration.ps1"),i.join("D:","Scripts","UserMandA","Scripts","DiscoveryCreateAppRegistration.ps1"),i.join(process.cwd(),"Scripts","DiscoveryCreateAppRegistration.ps1")];for(const t of e)if(n.existsSync(t))return console.log(`[AppRegistrationService] Found script at: ${t}`),t;return console.error("[AppRegistrationService] Script not found in any location"),null}();if(!t||!n.existsSync(t))return{success:!1,error:"App registration script not found. Expected at Scripts/DiscoveryCreateAppRegistration.ps1"};const s=function(e,t){const s=["-NoProfile","-ExecutionPolicy","Bypass","-File",`"${e}"`,"-CompanyName",`"${t.companyName}"`];t.autoInstallModules&&s.push("-AutoInstallModules");t.secretValidityYears&&s.push("-SecretValidityYears",t.secretValidityYears.toString());t.skipAzureRoles&&s.push("-SkipAzureRoles");return s}(t,e);if(console.log(`[AppRegistrationService] Launching script: ${t}`),console.log(`[AppRegistrationService] Company: ${e.companyName}`),await async function(e){const t={status:"in_progress",step:"Initialization",message:"Launching PowerShell app registration script...",progress:0,timestamp:(new Date).toISOString()};await g(e,t)}(e.companyName),e.showWindow){const s=["-CompanyName",`"${e.companyName}"`];e.autoInstallModules&&s.push("-AutoInstallModules"),e.secretValidityYears&&s.push("-SecretValidityYears",e.secretValidityYears.toString()),e.skipAzureRoles&&s.push("-SkipAzureRoles");const o=["/c","start",'""',"powershell.exe","-NoProfile","-ExecutionPolicy","Bypass","-NoExit","-File",`"${t}"`,...s];console.log("[AppRegistrationService] ========================================"),console.log("[AppRegistrationService] LAUNCHING POWERSHELL WINDOW (FILE-BASED MONITORING)"),console.log(`[AppRegistrationService] Script path: ${t}`),console.log(`[AppRegistrationService] Cmd args: ${JSON.stringify(o)}`),console.log("[AppRegistrationService] ========================================");const a=(0,r.spawn)("cmd.exe",o,{detached:!0,stdio:"ignore",windowsHide:!1,shell:!0});return a.unref(),console.log(`[AppRegistrationService] PowerShell window launched, PID: ${a.pid}`),function(e){const t=d(e),s=i.join("C:","DiscoveryData",e,"Credentials","credential_summary.json");console.log("[AppRegistrationService] ========================================"),console.log("[AppRegistrationService] Starting file-based status monitoring"),console.log(`[AppRegistrationService] Status file: ${t}`),console.log(`[AppRegistrationService] Credential file: ${s}`),console.log("[AppRegistrationService] Poll interval: 1000ms"),console.log("[AppRegistrationService] Max duration: 10 minutes"),console.log("[AppRegistrationService] ========================================");const r=Date.now();let o="";const a=setInterval(async()=>{try{const i=Date.now()-r;if(i>6e5){clearInterval(a),console.warn(`[AppRegistrationService] âš ï¸ File monitoring timeout after ${Math.round(i/1e3)}s`);const t={status:"failed",step:"Error",message:"Operation timed out after 10 minutes",progress:50,timestamp:(new Date).toISOString(),error:"Timeout exceeded"};return await g(e,t),void m(t)}if(n.existsSync(s)){clearInterval(a),console.log("[AppRegistrationService] âœ… Credential file detected - registration complete!");const t={status:"completed",step:"Complete",message:"App registration completed successfully",progress:100,timestamp:(new Date).toISOString()};return await g(e,t),void m(t)}if(n.existsSync(t)){const e=n.readFileSync(t,"utf-8");if(e!==o){o=e;try{const t=JSON.parse(e);console.log("[AppRegistrationService] ðŸ“„ Status file update:",{status:t.status,step:t.step,progress:t.progress,message:t.message.substring(0,50)+"..."}),m({status:"success"===t.status?"completed":"failed"===t.status?"failed":"in_progress",step:t.step,message:t.message,progress:t.progress||0,timestamp:t.timestamp,error:t.error}),"success"!==t.status&&"failed"!==t.status||(clearInterval(a),console.log(`[AppRegistrationService] ${"success"===t.status?"âœ… SUCCESS":"âŒ FAILED"} - monitoring stopped`))}catch(e){console.warn("[AppRegistrationService] âš ï¸ Failed to parse status file:",e)}}}else console.log(`[AppRegistrationService] â³ Waiting for status file... (${Math.round(i/1e3)}s elapsed)`)}catch(e){console.error("[AppRegistrationService] âŒ Error in file monitoring:",e)}},1e3);console.log(`[AppRegistrationService] File monitoring started (interval: ${a})`)}(e.companyName),{success:!0,message:"App registration script launched in new window (file-based monitoring active)",processId:a.pid}}return new Promise(t=>{const i=(0,r.spawn)("powershell.exe",s,{shell:!0,stdio:["ignore","pipe","pipe"]});let n=null,o="",a="";i.stdout?.on("data",t=>{const s=t.toString();o+=s;const r=s.split("\n");for(const t of r){const s=t.trim();if(s){const t=u(s);t&&(n=t,g(e.companyName,t),m(t))}}}),i.stderr?.on("data",t=>{const s=t.toString();a+=s;const r=s.split("\n");for(const t of r){const s=t.trim();if(s&&(s.toLowerCase().includes("error")||s.toLowerCase().includes("failed"))){const t={status:"failed",step:"Error",message:"Script error occurred",progress:n?.progress||0,timestamp:(new Date).toISOString(),error:s};g(e.companyName,t),m(t)}}}),i.on("close",async s=>{if(console.log(`[AppRegistrationService] Script exited with code: ${s}`),0===s){const s={status:"completed",step:"Complete",message:"App registration completed successfully",progress:100,timestamp:(new Date).toISOString()};await g(e.companyName,s),m(s),t({success:!0,message:"App registration completed successfully"})}else{const r={status:"failed",step:"Error",message:`App registration script failed with exit code ${s}`,progress:n?.progress||0,timestamp:(new Date).toISOString(),error:a||n?.error||`Exit code: ${s}`};await g(e.companyName,r),m(r),t({success:!1,error:`App registration script failed with exit code ${s}`,message:n?.message||a||"Unknown error"})}}),i.on("error",async s=>{const r={status:"failed",step:"Error",message:"Failed to launch PowerShell script",progress:0,timestamp:(new Date).toISOString(),error:s.message};await g(e.companyName,r),m(r),t({success:!1,error:`Failed to launch PowerShell: ${s.message}`})})})}catch(e){return console.error("[AppRegistrationService] Launch failed:",e),{success:!1,error:`Failed to launch app registration: ${e.message}`}}}function f(e){const t=i.join("C:","DiscoveryData",e,"Credentials");if(!n.existsSync(t))return!1;return[i.join(t,"credential_summary.json"),i.join(t,"discoverycredentials.summary.json"),i.join(t,"credential-summary.json")].some(e=>n.existsSync(e))}async function C(e){const t=[i.join("C:","DiscoveryData",e,"Credentials","credential_summary.json"),i.join("C:","DiscoveryData",e,"Credentials","discoverycredentials.summary.json"),i.join("C:","DiscoveryData",e,"Credentials","credential-summary.json")];let s="";for(const e of t)try{if(!n.existsSync(e))continue;console.log(`[AppRegistrationService] Attempting to read summary from: ${e}`);let t,r=await n.promises.readFile(e,"utf8");if(65279===r.charCodeAt(0)&&(r=r.slice(1)),!r||0===r.trim().length){s=`File exists but is empty: ${e}`;continue}try{t=JSON.parse(r)}catch(t){s=`Invalid JSON in file ${e}: ${t.message}`;continue}if(!t.TenantId||!t.ClientId){s=`Missing required fields (TenantId, ClientId) in ${e}`;continue}const o=i.dirname(e),a={TenantId:t.TenantId,ClientId:t.ClientId,CredentialFile:t.CredentialFile,Created:t.Created||t.CreatedDate||(new Date).toISOString(),Domain:t.Domain||""};if(a.CredentialFile&&!i.isAbsolute(a.CredentialFile)&&(a.CredentialFile=i.join(o,a.CredentialFile)),!a.CredentialFile){const e=[i.join(o,"discoverycredentials.config"),i.join(o,"credentials.config"),i.join(o,"app-credentials.config")];for(const t of e)if(n.existsSync(t)){a.CredentialFile=t;break}if(!a.CredentialFile){s=`No credential file specified and default not found in: ${o}`;continue}}if(!n.existsSync(a.CredentialFile)){s=`Credential file not found: ${a.CredentialFile}`;continue}return console.log(`[AppRegistrationService] Successfully read credential summary from: ${e}`),a}catch(t){s=`Unexpected error reading ${e}: ${t.message}`;continue}const r=s||`No credential summary file found in any expected location: ${t.join(", ")}`;throw console.error(`[AppRegistrationService] ${r}`),new Error(`Failed to read credential summary: ${r}`)}async function y(e){try{if(!n.existsSync(e))return console.error(`[AppRegistrationService] Credential file not found: ${e}`),null;let t=await n.promises.readFile(e,"utf8");65279===t.charCodeAt(0)&&(t=t.slice(1));try{const e=JSON.parse(t);if(e.ClientSecret)return console.log("[AppRegistrationService] Read client secret from plain JSON credential file"),e.ClientSecret}catch{console.log("[AppRegistrationService] Credential file is not plain JSON, trying DPAPI decryption")}const s=`\n      try {\n        $enc = (Get-Content -Raw -Path '${e.replace(/'/g,"''")}').Trim()\n        $ss = $enc | ConvertTo-SecureString\n        $bstr = [Runtime.InteropServices.Marshal]::SecureStringToBSTR($ss)\n        $json = [Runtime.InteropServices.Marshal]::PtrToStringUni($bstr)\n        [Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)\n        $credData = $json | ConvertFrom-Json\n        Write-Output $credData.ClientSecret\n      } catch {\n        Write-Error $_.Exception.Message\n        exit 1\n      }\n    `;return new Promise(e=>{const t=(0,r.spawn)("powershell.exe",["-NoProfile","-ExecutionPolicy","Bypass","-Command",s]);let i="",n="";t.stdout?.on("data",e=>{i+=e.toString()}),t.stderr?.on("data",e=>{n+=e.toString()}),t.on("close",t=>{0===t&&i.trim()?e(i.trim()):(console.error("[AppRegistrationService] Decryption failed:",n),e(null))}),t.on("error",t=>{console.error("[AppRegistrationService] PowerShell execution failed:",t),e(null)})})}catch(e){return console.error("[AppRegistrationService] Credential read error:",e),null}}async function A(e){try{const t=i.join("C:","DiscoveryData",e,"Logs","MandADiscovery_Registration_Log_status.json");if(!n.existsSync(t))return null;let s=await n.promises.readFile(t,"utf8");65279===s.charCodeAt(0)&&(s=s.slice(1));return JSON.parse(s)}catch(e){return console.error("[AppRegistrationService] Failed to read status file:",e),null}}async function R(e){try{const t=i.join("C:","DiscoveryData",e,"Logs","MandADiscovery_Registration_Log_status.json");n.existsSync(t)&&(await n.promises.unlink(t),console.log(`[AppRegistrationService] Cleared status file for ${e}`))}catch(e){console.error("[AppRegistrationService] Failed to clear status file:",e)}}}};
//# sourceMappingURL=src_main_ipc_appRegistrationHandlers_ts.main.js.map