"use strict";exports.id="src_main_services_enterpriseSystemsService_ts",exports.ids=["src_main_services_enterpriseSystemsService_ts"],exports.modules={"./src/main/services/enterpriseSystemsService.ts":(e,t,s)=>{s.d(t,{registerEnterpriseSystemsHandlers:()=>d});var n=s("electron"),r=s("https"),a=s("fs"),c=s("path");class o{config;accessToken=null;constructor(e){this.config=e}async getAuthHeader(){if(this.config.useOAuth&&this.config.clientId&&this.config.clientSecret)return this.accessToken||(this.accessToken=await this.getOAuthToken()),`Bearer ${this.accessToken}`;return`Basic ${Buffer.from(`${this.config.username}:${this.config.password}`).toString("base64")}`}async getOAuthToken(){return new Promise((e,t)=>{const s=new URL("/oauth_token.do",this.config.instanceUrl),n=new URLSearchParams({grant_type:"password",client_id:this.config.clientId,client_secret:this.config.clientSecret,username:this.config.username,password:this.config.password}).toString(),a={hostname:s.hostname,path:s.pathname,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(n)}},c=r.request(a,s=>{let n="";s.on("data",e=>n+=e),s.on("end",()=>{try{const s=JSON.parse(n);s.access_token?e(s.access_token):t(new Error(s.error_description||"OAuth failed"))}catch(e){t(e)}})});c.on("error",t),c.write(n),c.end()})}async testConnection(){try{const e=await this.getAuthHeader(),t=new URL("/api/now/table/sys_user?sysparm_limit=1",this.config.instanceUrl);return new Promise(s=>{const n=r.request({hostname:t.hostname,path:t.pathname+t.search,method:"GET",headers:{Authorization:e,Accept:"application/json"}},e=>{200===e.statusCode?s({success:!0}):s({success:!1,error:`HTTP ${e.statusCode}`})});n.on("error",e=>s({success:!1,error:e.message})),n.end()})}catch(e){return{success:!1,error:e.message}}}async extractData(e){const t={cmdb:"cmdb_ci",incidents:"incident",users:"sys_user",requests:"sc_request",changes:"change_request"}[e];if(!t)return{success:!1,error:`Unknown data type: ${e}`};try{const e=await this.getAuthHeader(),s=[];let n=0;const a=1e3;let c=!0;for(;c;){const o=new URL(`/api/now/table/${t}?sysparm_limit=${a}&sysparm_offset=${n}`,this.config.instanceUrl),i=await new Promise((t,s)=>{const n=r.request({hostname:o.hostname,path:o.pathname+o.search,method:"GET",headers:{Authorization:e,Accept:"application/json"}},e=>{let n="";e.on("data",e=>n+=e),e.on("end",()=>{try{const e=JSON.parse(n);t(e.result||[])}catch(e){s(e)}})});n.on("error",s),n.end()});s.push(...i),c=i.length===a,n+=a}return{success:!0,data:s,recordCount:s.length}}catch(e){return{success:!1,error:e.message}}}}class i{config;constructor(e){this.config=e}getAuthHeader(){return`Basic ${Buffer.from(`${this.config.email}:${this.config.apiToken}`).toString("base64")}`}async testConnection(){try{const e=new URL("/rest/api/3/myself",this.config.baseUrl);return new Promise(t=>{const s=r.request({hostname:e.hostname,path:e.pathname,method:"GET",headers:{Authorization:this.getAuthHeader(),Accept:"application/json"}},e=>{200===e.statusCode?t({success:!0}):t({success:!1,error:`HTTP ${e.statusCode}`})});s.on("error",e=>t({success:!1,error:e.message})),s.end()})}catch(e){return{success:!1,error:e.message}}}async extractData(e){const t={projects:"/rest/api/3/project",issues:"/rest/api/3/search?maxResults=1000",users:"/rest/api/3/users/search?maxResults=1000",boards:"/rest/agile/1.0/board"}[e];if(!t)return{success:!1,error:`Unknown data type: ${e}`};try{const s=new URL(t,this.config.baseUrl),n=await new Promise((e,t)=>{const n=r.request({hostname:s.hostname,path:s.pathname+s.search,method:"GET",headers:{Authorization:this.getAuthHeader(),Accept:"application/json"}},s=>{let n="";s.on("data",e=>n+=e),s.on("end",()=>{try{e(JSON.parse(n))}catch(e){t(e)}})});n.on("error",t),n.end()}),a="issues"===e?n.issues:Array.isArray(n)?n:n.values||[];return{success:!0,data:a,recordCount:a.length}}catch(e){return{success:!1,error:e.message}}}}class u{config;accessToken=null;constructor(e){this.config=e}async testConnection(){try{return this.config.clientId&&this.config.clientSecret?{success:!0,details:"Workday connection test (placeholder)"}:{success:!1,error:"OAuth credentials required for Workday"}}catch(e){return{success:!1,error:e.message}}}async extractData(e){return{employees:"/ccx/service/tenant/Human_Resources/v40.0/Get_Workers",costCenters:"/ccx/service/tenant/Financial_Management/v40.0/Get_Cost_Centers",organizations:"/ccx/service/tenant/Human_Resources/v40.0/Get_Organizations",positions:"/ccx/service/tenant/Human_Resources/v40.0/Get_Positions"}[e]?{success:!0,data:[],recordCount:0,error:"Workday extraction requires custom implementation per tenant"}:{success:!1,error:`Unknown data type: ${e}`}}}class h{config;accessToken=null;constructor(e){this.config=e}async getAccessToken(){return this.accessToken?this.accessToken:new Promise((e,t)=>{const s=new URL("/services/mtm/v1/oauth2/token",this.config.instanceUrl),n=new URLSearchParams({grant_type:"client_credentials"}).toString(),a=r.request({hostname:s.hostname,path:s.pathname,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`apitoken:${this.config.apiToken}`).toString("base64")}`}},s=>{let n="";s.on("data",e=>n+=e),s.on("end",()=>{try{const s=JSON.parse(n);s.access_token?(this.accessToken=s.access_token,e(s.access_token)):t(new Error("Failed to get LeanIX access token"))}catch(e){t(e)}})});a.on("error",t),a.write(n),a.end()})}async testConnection(){try{return{success:!0,details:{tokenObtained:!!await this.getAccessToken()}}}catch(e){return{success:!1,error:e.message}}}async extractData(e){try{const t=await this.getAccessToken(),s={query:`\n          query {\n            allFactSheets(filter: {factSheetType: ${e}}) {\n              edges {\n                node {\n                  id\n                  name\n                  type\n                  description\n                  ... on ${e} {\n                    lifecycle {\n                      asString\n                    }\n                    businessCriticality\n                    technicalFit\n                    functionalFit\n                  }\n                }\n              }\n            }\n          }\n        `},n=new URL("/services/pathfinder/v1/graphql",this.config.instanceUrl),a=await new Promise((e,a)=>{const c=JSON.stringify(s),o=r.request({hostname:n.hostname,path:n.pathname,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"Content-Length":Buffer.byteLength(c)}},t=>{let s="";t.on("data",e=>s+=e),t.on("end",()=>{try{e(JSON.parse(s))}catch(e){a(e)}})});o.on("error",a),o.write(c),o.end()}),c=a?.data?.allFactSheets?.edges?.map(e=>e.node)||[];return{success:!0,data:c,recordCount:c.length}}catch(e){return{success:!1,error:e.message}}}}function d(){n.ipcMain.handle("enterprise-test-connection",async(e,t)=>{const{system:s,config:n}=t;switch(s){case"serviceNow":{const e=new o(n);return await e.testConnection()}case"jira":{const e=new i(n);return await e.testConnection()}case"workday":{const e=new u(n);return await e.testConnection()}case"leanIX":{const e=new h(n);return await e.testConnection()}default:return{success:!1,error:`Unknown system: ${s}`}}}),n.ipcMain.handle("enterprise-extract-data",async(e,t)=>{const{system:s,config:n,dataType:r,companyName:d}=t;let l;switch(s){case"serviceNow":{const e=new o(n);l=await e.extractData(r);break}case"jira":{const e=new i(n);l=await e.extractData(r);break}case"workday":{const e=new u(n);l=await e.extractData(r);break}case"leanIX":{const e=new h(n);l=await e.extractData(r);break}default:l={success:!1,error:`Unknown system: ${s}`}}if(l.success&&l.data&&l.data.length>0&&d)try{const e=c.join(process.env.DISCOVERY_DATA_PATH||"C:\\DiscoveryData",d,"Raw");a.existsSync(e)||a.mkdirSync(e,{recursive:!0});const t=`${s}_${r}.csv`,n=c.join(e,t);if(l.data.length>0){const e=Object.keys(l.data[0]),t=[e.join(","),...l.data.map(t=>e.map(e=>{const s=t[e];if(null==s)return"";const n=String(s);return n.includes(",")||n.includes('"')||n.includes("\n")?`"${n.replace(/"/g,'""')}"`:n}).join(","))].join("\n");a.writeFileSync(n,t,"utf8")}}catch(e){console.error("Failed to save enterprise data to CSV:",e)}return l}),console.log("[EnterpriseSystemsService] IPC handlers registered")}}};
//# sourceMappingURL=src_main_services_enterpriseSystemsService_ts.main.js.map