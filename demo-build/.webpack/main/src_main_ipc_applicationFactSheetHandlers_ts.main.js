"use strict";exports.id="src_main_ipc_applicationFactSheetHandlers_ts",exports.ids=["src_main_ipc_applicationFactSheetHandlers_ts"],exports.modules={"./src/main/ipc/applicationFactSheetHandlers.ts":(e,t,i)=>{i.d(t,{registerApplicationFactSheetHandlers:()=>r});var s=i("electron"),a=i("./src/main/services/applicationFactsService.ts");function r(){const e=(0,a.getApplicationFactsService)();s.ipcMain.handle("factsheet:create",async(t,{sourceProfileId:i,name:s,inventoryEntityId:a})=>{try{console.log("[IPC] factsheet:create",s);return{success:!0,data:await e.create(i,s,a)}}catch(e){return console.error("[IPC] factsheet:create error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:getById",async(t,i)=>{try{console.log("[IPC] factsheet:getById",i);const t=await e.getById(i);return t?{success:!0,data:t}:{success:!1,error:"Fact sheet not found"}}catch(e){return console.error("[IPC] factsheet:getById error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:getByInventoryEntity",async(t,i)=>{try{console.log("[IPC] factsheet:getByInventoryEntity",i);return{success:!0,data:await e.getByInventoryEntityId(i)}}catch(e){return console.error("[IPC] factsheet:getByInventoryEntity error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:getAll",async(t,i)=>{try{console.log("[IPC] factsheet:getAll",i);return{success:!0,data:await e.getAll(i)}}catch(e){return console.error("[IPC] factsheet:getAll error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:updateSection",async(t,{id:i,section:s,updates:a,updatedBy:r})=>{try{console.log("[IPC] factsheet:updateSection",i,s);const t=await e.updateSection(i,s,a,r);return t?{success:!0,data:t}:{success:!1,error:"Fact sheet not found"}}catch(e){return console.error("[IPC] factsheet:updateSection error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:delete",async(t,i)=>{try{console.log("[IPC] factsheet:delete",i);return await e.delete(i)?{success:!0,data:{deleted:!0}}:{success:!1,error:"Fact sheet not found"}}catch(e){return console.error("[IPC] factsheet:delete error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:addObservation",async(t,{applicationId:i,field:s,value:a,source:r,sourceFile:n,confidence:o})=>{try{console.log("[IPC] factsheet:addObservation",i,s);const t=await e.addObservation(i,s,a,r,n,o);return t?{success:!0,data:t}:{success:!1,error:"Fact sheet not found"}}catch(e){return console.error("[IPC] factsheet:addObservation error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:verifyObservation",async(t,{applicationId:i,observationId:s,verifiedBy:a})=>{try{console.log("[IPC] factsheet:verifyObservation",i,s);const t=await e.verifyObservation(i,s,a);return t?{success:!0,data:t}:{success:!1,error:"Observation not found"}}catch(e){return console.error("[IPC] factsheet:verifyObservation error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:getObservations",async(t,{applicationId:i,field:s})=>{try{console.log("[IPC] factsheet:getObservations",i,s);return{success:!0,data:await e.getObservationHistory(i,s)}}catch(e){return console.error("[IPC] factsheet:getObservations error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:addRelation",async(t,{sourceId:i,sourceType:s,targetId:a,targetType:r,targetName:n,relationType:o,source:c,description:l})=>{try{console.log("[IPC] factsheet:addRelation",i,o,n);const t=await e.addRelation(i,s,a,r,n,o,c,l);return t?{success:!0,data:t}:{success:!1,error:"Fact sheet not found"}}catch(e){return console.error("[IPC] factsheet:addRelation error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:removeRelation",async(t,{applicationId:i,relationId:s})=>{try{console.log("[IPC] factsheet:removeRelation",i,s);return await e.removeRelation(i,s)?{success:!0,data:{removed:!0}}:{success:!1,error:"Relation not found"}}catch(e){return console.error("[IPC] factsheet:removeRelation error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:getRelations",async(t,i)=>{try{console.log("[IPC] factsheet:getRelations",i);return{success:!0,data:await e.getRelations(i)}}catch(e){return console.error("[IPC] factsheet:getRelations error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:getStatistics",async(t,i)=>{try{console.log("[IPC] factsheet:getStatistics",i);return{success:!0,data:await e.getStatistics(i)}}catch(e){return console.error("[IPC] factsheet:getStatistics error:",e),{success:!1,error:e.message}}}),s.ipcMain.handle("factsheet:importFromDiscovery",async(t,{sourceProfileId:i,applications:s,source:a,sourceFile:r})=>{try{console.log("[IPC] factsheet:importFromDiscovery",s.length,"applications from",a);return{success:!0,data:await e.importFromDiscovery(i,s,a,r)}}catch(e){return console.error("[IPC] factsheet:importFromDiscovery error:",e),{success:!1,error:e.message}}}),console.log("[ApplicationFactSheetHandlers] Registered 14 IPC handlers")}},"./src/main/services/applicationFactsService.ts":(e,t,i)=>{i.d(t,{getApplicationFactsService:()=>h});var s=i("path"),a=i("fs/promises"),r=i("electron"),n=i("./node_modules/lowdb/lib/index.js"),o=i("./node_modules/lowdb/lib/node.js"),c=i("./node_modules/uuid/index.js");class l{db;isInitialized=!1;dbPath;constructor(){this.dbPath=s.join(r.app.getPath("appData"),"MandADiscoverySuite","application-facts.json")}async initialize(){if(this.isInitialized)return;await a.mkdir(s.dirname(this.dbPath),{recursive:!0});const e=new o.JSONFile(this.dbPath);this.db=new n.Low(e,{factSheets:[],version:1}),await this.db.read(),this.ensureData(),this.isInitialized=!0,console.log("[ApplicationFactsService] Initialized with",this.db.data?.factSheets.length,"fact sheets")}ensureData(){this.db.data||(this.db.data={factSheets:[],version:1}),this.db.data.factSheets||(this.db.data.factSheets=[]),this.db.data.version||(this.db.data.version=1)}async create(e,t,i){await this.initialize();const s=(new Date).toISOString(),a={id:(0,c.v4)(),sourceProfileId:e,inventoryEntityId:i,baseInfo:{name:t,tags:[],aliases:[]},lifecycle:{phase:"active"},business:{criticality:"business_operational",businessCapabilities:[],businessProcesses:[],departments:[]},technical:{complexity:"standard",languages:[],frameworks:[],infrastructure:[],databases:[],integrations:[],apisExposed:[],apisConsumed:[],documentationUrls:[]},security:{dataClassification:"internal",containsPII:!1,containsPHI:!1,containsFinancialData:!1,complianceRequirements:[],ssoEnabled:!1,vulnerabilities:[]},migration:{disposition:"retain",status:"not_started",blockers:[],prerequisites:[],validationSteps:[],riskLevel:"medium",riskFactors:[]},relations:[],observations:[],createdAt:s,updatedAt:s,readinessScore:0,overallRiskScore:50,completenessScore:0};return this.db.data.factSheets.push(a),await this.db.write(),console.log("[ApplicationFactsService] Created fact sheet:",a.id,t),a}async getById(e){return await this.initialize(),this.db.data.factSheets.find(t=>t.id===e)||null}async getByInventoryEntityId(e){return await this.initialize(),this.db.data.factSheets.find(t=>t.inventoryEntityId===e)||null}async getAll(e){await this.initialize();let t=this.db.data.factSheets;if(e){if(e.sourceProfileId&&(t=t.filter(t=>t.sourceProfileId===e.sourceProfileId)),e.lifecyclePhase?.length&&(t=t.filter(t=>e.lifecyclePhase.includes(t.lifecycle.phase))),e.criticality?.length&&(t=t.filter(t=>e.criticality.includes(t.business.criticality))),e.disposition?.length&&(t=t.filter(t=>e.disposition.includes(t.migration.disposition))),e.waveId&&(t=t.filter(t=>t.migration.waveId===e.waveId)),e.search){const i=e.search.toLowerCase();t=t.filter(e=>e.baseInfo.name.toLowerCase().includes(i)||e.baseInfo.vendor?.toLowerCase().includes(i)||e.baseInfo.description?.toLowerCase().includes(i))}e.tags?.length&&(t=t.filter(t=>e.tags.some(e=>t.baseInfo.tags.includes(e)))),void 0!==e.minReadinessScore&&(t=t.filter(t=>t.readinessScore>=e.minReadinessScore)),void 0!==e.maxRiskScore&&(t=t.filter(t=>t.overallRiskScore<=e.maxRiskScore))}return t.map(e=>({id:e.id,name:e.baseInfo.name,vendor:e.baseInfo.vendor,lifecyclePhase:e.lifecycle.phase,criticality:e.business.criticality,disposition:e.migration.disposition,readinessScore:e.readinessScore,riskScore:e.overallRiskScore,relationCount:e.relations.length,completenessScore:e.completenessScore}))}async updateSection(e,t,i,s){await this.initialize();const a=this.db.data.factSheets.find(t=>t.id===e);return a?(a[t]={...a[t],...i},a.updatedAt=(new Date).toISOString(),s&&(a.updatedBy=s),this.calculateScores(a),await this.db.write(),console.log("[ApplicationFactsService] Updated section:",t,"for",e),a):null}async delete(e){await this.initialize();const t=this.db.data.factSheets.findIndex(t=>t.id===e);return-1!==t&&(this.db.data.factSheets.splice(t,1),await this.db.write(),console.log("[ApplicationFactsService] Deleted fact sheet:",e),!0)}async addObservation(e,t,i,s,a,r="medium"){await this.initialize();const n=this.db.data.factSheets.find(t=>t.id===e);if(!n)return null;n.observations.filter(e=>e.field===t&&e.isActive).forEach(e=>e.isActive=!1);const o={id:(0,c.v4)(),applicationId:e,field:t,value:i,provenance:{source:s,discoveredAt:(new Date).toISOString(),confidence:r,sourceFile:a,verified:!1},isActive:!0};return n.observations.push(o),n.updatedAt=(new Date).toISOString(),this.applyObservationValue(n,t,i),this.calculateScores(n),await this.db.write(),console.log("[ApplicationFactsService] Added observation for",t,"from",s),o}async verifyObservation(e,t,i){await this.initialize();const s=this.db.data.factSheets.find(t=>t.id===e);if(!s)return null;const a=s.observations.find(e=>e.id===t);return a?(a.provenance.verified=!0,a.provenance.verifiedBy=i,a.provenance.verifiedAt=(new Date).toISOString(),a.provenance.confidence="high",s.updatedAt=(new Date).toISOString(),this.calculateScores(s),await this.db.write(),a):null}async getObservationHistory(e,t){await this.initialize();const i=this.db.data.factSheets.find(t=>t.id===e);return i?t?i.observations.filter(e=>e.field===t):i.observations:[]}async addRelation(e,t,i,s,a,r,n,o){await this.initialize();const l=this.db.data.factSheets.find(t=>t.id===e);if(!l)return null;const d=l.relations.find(e=>e.targetId===i&&e.relationType===r);if(d)return console.log("[ApplicationFactsService] Relation already exists, skipping"),d;const h={id:(0,c.v4)(),sourceId:e,sourceType:t,targetId:i,targetType:s,targetName:a,relationType:r,description:o,provenance:{source:n,discoveredAt:(new Date).toISOString(),confidence:"medium",verified:!1}};return l.relations.push(h),l.updatedAt=(new Date).toISOString(),await this.db.write(),console.log("[ApplicationFactsService] Added relation:",r,"to",a),h}async removeRelation(e,t){await this.initialize();const i=this.db.data.factSheets.find(t=>t.id===e);if(!i)return!1;const s=i.relations.findIndex(e=>e.id===t);return-1!==s&&(i.relations.splice(s,1),i.updatedAt=(new Date).toISOString(),await this.db.write(),!0)}async getRelations(e){await this.initialize();const t=this.db.data.factSheets.find(t=>t.id===e);return t?.relations||[]}async getStatistics(e){await this.initialize();let t=this.db.data.factSheets;e&&(t=t.filter(t=>t.sourceProfileId===e));const i={total:t.length,byLifecycle:{plan:0,phase_in:0,active:0,phase_out:0,end_of_life:0},byCriticality:{mission_critical:0,business_critical:0,business_operational:0,administrative:0},byDisposition:{retain:0,retire:0,replace:0,rehost:0,refactor:0,replatform:0,repurchase:0},byWave:{},averageReadiness:0,averageRisk:0,averageCompleteness:0};if(0===t.length)return i;let s=0,a=0,r=0;for(const e of t)i.byLifecycle[e.lifecycle.phase]++,i.byCriticality[e.business.criticality]++,i.byDisposition[e.migration.disposition]++,e.migration.waveId&&(i.byWave[e.migration.waveId]=(i.byWave[e.migration.waveId]||0)+1),s+=e.readinessScore,a+=e.overallRiskScore,r+=e.completenessScore;return i.averageReadiness=Math.round(s/t.length),i.averageRisk=Math.round(a/t.length),i.averageCompleteness=Math.round(r/t.length),i}async importFromDiscovery(e,t,i,s){await this.initialize();let a=0,r=0,n=0;for(const o of t)try{const t=o.DisplayName||o.Name||o.displayName||o.name;if(!t){n++;continue}let c=this.db.data.factSheets.find(i=>i.sourceProfileId===e&&i.baseInfo.name.toLowerCase()===t.toLowerCase());c?r++:(c=await this.create(e,t),a++);const l={Publisher:"baseInfo.vendor",Vendor:"baseInfo.vendor",Version:"baseInfo.version",Description:"baseInfo.description",AppId:"baseInfo.externalId",ApplicationId:"baseInfo.externalId"};for(const[e,t]of Object.entries(l))o[e]&&await this.addObservation(c.id,t,o[e],i,s,"medium")}catch(e){console.error("[ApplicationFactsService] Import error:",e),n++}return console.log("[ApplicationFactsService] Import complete:",a,"created,",r,"updated,",n,"errors"),{created:a,updated:r,errors:n}}applyObservationValue(e,t,i){const s=t.split(".");if(2!==s.length)return;const[a,r]=s;a in e&&"object"==typeof e[a]&&(e[a][r]=i)}calculateScores(e){let t=0,i=0;const s=(e,s)=>{for(const a of s){i++;const s=e[a];null!=s&&""!==s&&(!Array.isArray(s)||s.length>0)&&t++}};s(e.baseInfo,["name","description","vendor","version","applicationType"]),s(e.lifecycle,["phase","phaseStartDate"]),s(e.business,["criticality","businessOwner","departments","userCount"]),s(e.technical,["complexity","technicalOwner","hostingType","languages"]),s(e.security,["dataClassification","authenticationMethod","ssoEnabled"]),s(e.migration,["disposition","status"]),e.completenessScore=Math.round(t/i*100);let a=.4*e.completenessScore;"retain"!==e.migration.disposition&&(a+=10),"completed"===e.migration.status?a+=30:"in_progress"===e.migration.status?a+=20:e.migration.waveId&&(a+=10);const r=e.observations.filter(e=>e.provenance.verified).length;a+=Math.min(2*r,20),e.readinessScore=Math.min(Math.round(a),100);let n=50;"mission_critical"===e.business.criticality?n+=20:"business_critical"===e.business.criticality?n+=10:"administrative"===e.business.criticality&&(n-=10),"highly_complex"===e.technical.complexity?n+=15:"complex"===e.technical.complexity?n+=10:"simple"===e.technical.complexity&&(n-=10),e.security.containsPII&&(n+=10),e.security.containsPHI&&(n+=15),e.security.containsFinancialData&&(n+=10),e.security.ssoEnabled||(n+=5),n+=5*e.migration.blockers.length,e.overallRiskScore=Math.max(0,Math.min(Math.round(n),100))}}let d=null;function h(){return d||(d=new l),d}}};
//# sourceMappingURL=src_main_ipc_applicationFactSheetHandlers_ts.main.js.map