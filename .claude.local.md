# Claude Code Local Notes - UserMandA Project

## Working Directory Conventions

### Primary Working Directory
**ALL development work MUST be done in**: `C:\enterprisediscovery\`

### Sample Data Location
**Sample company with raw discovery data**: `C:\discoverydata\ljpops\`

### Critical Workspace Synchronization Rule
⚠️ **MANDATORY**: Any changes made to files in `C:\enterprisediscovery\` MUST be copied back to `D:\Scripts\UserMandA\`

---

## GUIV2 Architecture (Electron + React)

### Technology Stack
- **Platform**: Cross-platform (Electron)
- **Language**: TypeScript + React
- **Process Model**: Multi-process (main/renderer)
- **State**: Redux Toolkit
- **Build**: Webpack + Electron-forge

### Build & Deploy from Deployment Directory

```powershell
cd C:\enterprisediscovery

# Build main process (REQUIRED after TypeScript changes)
npx webpack --config webpack.main.config.js

# Copy PowerShell modules (REQUIRED for discovery)
Copy-Item D:\Scripts\UserMandA\Modules C:\enterprisediscovery\Modules -Recurse -Force
Copy-Item D:\Scripts\UserMandA\Core C:\enterprisediscovery\Core -Recurse -Force
Copy-Item D:\Scripts\UserMandA\Scripts C:\enterprisediscovery\Scripts -Recurse -Force

# Start application
npm start
```

**Critical Paths**:
- PowerShell modules: `C:\enterprisediscovery\Modules\Discovery\*.psm1`
- Data files: `C:\discoverydata\ljpops\Raw\`
- Credentials: `C:\Users\{user}\AppData\Roaming\Electron\credentials.enc`

---

## Discovery Module Integration - PowerShell Window & Credentials

### How Azure Discovery Window Launches with Credentials

**Complete Flow** (`discovery:execute` handler in ipcHandlers.ts:2279-2459):

1. **Frontend Initiates Discovery** (`useAzureDiscoveryLogic.ts:261-279`):
   ```typescript
   const result = await window.electron.executeDiscovery({
     moduleName: 'Azure',
     parameters: {
       IncludeUsers: true,
       IncludeGroups: true,
       showWindow: true,  // Controls PowerShell window visibility
       timeout: 1800000
     },
     executionId: token
   });
   ```

2. **IPC Handler Gets Active Profile** (`ipcHandlers.ts:2392-2406`):
   ```typescript
   const activeProfile = await profileService.getCurrentProfile();
   // Profile contains: companyName, tenantId, clientId, clientSecret
   console.log(`[IPC:discovery:execute] Starting ${moduleName} discovery`);
   console.log(`[IPC:discovery:execute] Company: ${activeProfile.companyName}`);
   ```

3. **Execute with Credentials** (`ipcHandlers.ts:2409-2419`):
   ```typescript
   const result = await psService.executeDiscoveryModule(
     moduleName,                    // 'Azure'
     activeProfile.companyName,     // 'ljpops'
     parameters,                    // { IncludeUsers: true, showWindow: true, ... }
     {
       cancellationToken: execId,
       streamOutput: true,
       timeout: parameters.timeout || 300000,
       showWindow: parameters.showWindow !== undefined ? parameters.showWindow : true
     }
   );
   ```

4. **PowerShell Service Loads Credentials** (`powerShellService.ts:1091-1143`):
   ```typescript
   async executeDiscoveryModule(moduleName, companyName, additionalParams, options) {
     // Load credentials from CredentialService (3-tier precedence)
     const credentials = await this.credentialService.getCredential(companyName);

     const discoveryParams = {
       CompanyName: companyName,
       TenantId: credentials.tenantId,        // Real Azure tenant ID
       ClientId: credentials.clientId,        // Service principal ID
       ClientSecret: credentials.clientSecret, // Encrypted secret
       OutputPath: `C:\\DiscoveryData\\${companyName}\\Raw`,
       AdditionalParams: additionalParams     // Nested hashtable
     };
   }
   ```

5. **Launch PowerShell Window** (`powerShellService.ts:374-414`):
   ```typescript
   // If showWindow enabled, spawn VISIBLE PowerShell console
   if (options.showWindow && process.platform === 'win32') {
     console.log(`[PowerShellService] Spawning VISIBLE PowerShell window`);

     // Use cmd.exe with 'start' - ONLY reliable way to show console from Electron
     const cmdArgs = [
       '/c',
       'start',
       '""',  // Empty title required by start command
       'powershell.exe',
       '-NoProfile',
       '-ExecutionPolicy', 'Bypass',
       '-NoExit',  // Keep window open after completion
       '-File',
       `"${resolvedPath}"`,
       ...args.map(arg => `"${arg}"`)
     ];

     childProcess = spawn('cmd.exe', cmdArgs, {
       shell: true,
       windowsHide: false
     });
   }
   ```

6. **PowerShell Module Receives Credentials** (`AzureDiscovery.psm1:150-176`):
   ```powershell
   function Start-AzureDiscovery {
     param(
       [string]$CompanyName,
       [string]$TenantId,      # From credentials
       [string]$ClientId,      # From credentials
       [string]$ClientSecret,  # From credentials
       [string]$OutputPath,
       [hashtable]$AdditionalParams = @{}  # Contains showWindow, IncludeUsers, etc.
     )

     Write-Information "[AzureDiscovery] Starting Azure discovery for $CompanyName..."
     Write-Information "[AzureDiscovery] Tenant ID: $TenantId"
   }
   ```

### Credential Loading Architecture (3-Tier Precedence)

**CredentialService** (`credentialService.ts`):

1. **Environment Variables** (highest priority):
   - `MANDA_TENANT_ID`, `MANDA_CLIENT_ID`, `MANDA_CLIENT_SECRET`
   - Used for CI/CD, containers

2. **SafeStorage Encrypted** (modern, secure):
   - File: `C:\Users\{user}\AppData\Roaming\Electron\credentials.enc`
   - Encrypted using Electron's safeStorage API
   - Auto-migrated from legacy on first load

3. **Legacy Unencrypted** (fallback):
   - Path: `C:\discoverydata\{profile}\Credentials\discoverycredentials.config`
   - JSON format (plaintext)

### PowerShell Output Streaming Architecture

**Stream Parsing** (`powerShellService.ts:627-704`):

```typescript
private parseStderrStreams(chunk, executionId, streamOutput, ...) {
  for (const line of lines) {
    if (line.startsWith('WARNING: ')) {
      this.emit('stream:warning', ...);
    } else if (line.startsWith('VERBOSE: ')) {
      this.emit('stream:verbose', ...);
    } else if (line.startsWith('INFORMATION: ') || line.startsWith('INFO: ')) {
      this.emit('stream:information', ...);
    } else if (line.includes('ERROR:')) {
      this.emit('stream:error', ...);
    } else {
      // IMPORTANT: All other non-empty lines are treated as Information stream
      // This handles Write-Information output without explicit prefixes
      this.emit('stream:information', line);
    }
  }
}
```

**Key Insight**: PowerShell's `Write-Information` doesn't always add "INFORMATION: " prefix. The else clause captures unprefixed output.

### Event Flow to Frontend

**IPC Event Listeners** (`ipcHandlers.ts:2303-2390`):

```typescript
// Register stream listeners BEFORE executing
psService.on('stream:output', (data) => {
  mainWindow.webContents.send('discovery:output', {
    executionId: execId,
    level: 'output',
    message: data.data
  });
});

psService.on('stream:information', (data) => {
  mainWindow.webContents.send('discovery:output', {
    executionId: execId,
    level: 'information',
    message: data.data
  });
});
// ... similar for warning, error, verbose, debug
```

**Frontend Hook** (`useAzureDiscoveryLogic.ts:98-189`):

```typescript
useEffect(() => {
  const unsubscribeOutput = window.electron.onDiscoveryOutput((data) => {
    if (data.executionId === currentToken) {
      addLog(`[${data?.level?.toUpperCase()}] ${data.message}`);
    }
  });

  const unsubscribeComplete = window.electron.onDiscoveryComplete((data) => {
    if (data.executionId === currentToken) {
      setIsRunning(false);
      setIsCancelling(false);
      setCurrentToken(null);
      setLocalProgress(null);
    }
  });

  const unsubscribeCancelled = window.electron.onDiscoveryCancelled?.((data) => {
    if (data.executionId === currentToken) {
      // Reset UI to start state
      setIsRunning(false);
      setIsCancelling(false);
      setCurrentToken(null);
      setLocalProgress(null);
    }
  });

  return () => {
    unsubscribeOutput?.();
    unsubscribeComplete?.();
    unsubscribeCancelled?.();
  };
}, [currentToken]);
```

### Cancel Button State Management

**Cancel Handler** (`useAzureDiscoveryLogic.ts:309-335`):

```typescript
const cancelDiscovery = useCallback(async () => {
  if (!currentToken) return;

  setIsCancelling(true);
  addLog('Cancelling discovery...');

  try {
    await window.electron.cancelDiscovery(currentToken);

    // Timeout fallback in case cancelled event doesn't fire
    setTimeout(() => {
      setIsRunning(false);
      setIsCancelling(false);
      setCurrentToken(null);
      setLocalProgress(null);
    }, 2000);
  } catch (err) {
    // Reset state even on error
    setIsRunning(false);
    setIsCancelling(false);
    setCurrentToken(null);
    setLocalProgress(null);
  }
}, [currentToken]);
```

---

## Discovery Module Streaming Output - Standard Pattern

### Required Changes for ALL Discovery Modules

**1. Module Base** (`DiscoveryBase.psm1:152-173`) - ✅ FIXED

```powershell
function Write-ModuleLog {
    param([string]$ModuleName, [string]$Message, [string]$Level = "INFO")

    # Use proper PowerShell streams (NOT Write-Host)
    switch ($Level) {
        "ERROR" { Write-Error "[$ModuleName] $Message" }
        "WARN" { Write-Warning "[$ModuleName] $Message" }
        "DEBUG" { Write-Debug "[$ModuleName] $Message" }
        "VERBOSE" { Write-Verbose "[$ModuleName] $Message" -Verbose }
        default { Write-Information "[$ModuleName] $Message" -InformationAction Continue }
    }
}
```

**2. PowerShell Service** (`powerShellService.ts:907-1058`) - ✅ FIXED

```typescript
// Enable streams at module execution start
const command = `
  $InformationPreference = 'Continue'
  $VerbosePreference = 'SilentlyContinue'  # Suppress Graph SDK HTTP spam
  $DebugPreference = 'SilentlyContinue'
  $WarningPreference = 'Continue'

  Import-Module '${modulePath}' -Force -ErrorAction Stop

  # Execute with stream redirection to keep stdout clean for JSON
  $result = ${functionName} @params 6>&2

  # Output JSON markers
  Write-Output "<<<JSON_RESULT_START>>>"
  $result | ConvertTo-Json -Depth 10 -Compress
  Write-Output "<<<JSON_RESULT_END>>>"
`;
```

**3. Replace Write-Host in Discovery Modules**:

```powershell
# OLD (breaks streaming):
Write-Host "Starting discovery..." -ForegroundColor Green

# NEW (enables streaming):
Write-Information "[ModuleName] Starting discovery..." -InformationAction Continue
```

### Modules Requiring Fix

Search for Write-Host in all modules:
```powershell
Get-ChildItem C:\enterprisediscovery\Modules\Discovery\*.psm1 |
  Select-String "Write-Host" |
  Group-Object Path |
  Select-Object Name, Count
```

**Status**:
- ✅ AzureDiscovery.psm1 - FIXED
- ⚠️ ActiveDirectoryDiscovery.psm1 - PENDING
- ⚠️ ExchangeDiscovery.psm1 - PENDING
- ⚠️ IntuneDiscovery.psm1 - PENDING
- ⚠️ SharePointDiscovery.psm1 - PENDING
- ⚠️ OneDriveDiscovery.psm1 - PENDING
- ⚠️ TeamsDiscovery.psm1 - PENDING
- ⚠️ (All other discovery modules) - PENDING

### Testing Pattern

```powershell
cd C:\enterprisediscovery
npm start

# In GUIV2:
# 1. Select discovery module
# 2. Enable "Show PowerShell Window"
# 3. Start discovery
# 4. Verify BOTH:
#    - PowerShell window shows output
#    - Execution log streams messages
```

---

## Sync Changes Back to Workspace

```powershell
# After verifying changes work:
Copy-Item C:\enterprisediscovery\Modules\Discovery\*.psm1 D:\Scripts\UserMandA\Modules\Discovery\
Copy-Item C:\enterprisediscovery\src\main\services\powerShellService.ts D:\Scripts\UserMandA\guiv2\src\main\services\
Copy-Item C:\enterprisediscovery\src\main\ipcHandlers.ts D:\Scripts\UserMandA\guiv2\src\main\
Copy-Item C:\enterprisediscovery\src\renderer\hooks\useAzureDiscoveryLogic.ts D:\Scripts\UserMandA\guiv2\src\renderer\hooks\
```
