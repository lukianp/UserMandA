# Claude Code Local Notes - UserMandA Project

## Discovery Module Structure Issues (2025-11-05)

### Problem Identified
The Azure discovery module (and likely other discovery modules) have a **critical structural bug** where the `Invoke-*Discovery` function has improper brace matching. This causes the `Start-DiscoveryModule` orchestration call to be positioned incorrectly.

### Root Cause
The discovery modules were standardized for the old `/gui/` application and worked there. When migrating to `guiv2`, a brace mismatch issue appeared in `AzureDiscovery.psm1`:

1. **Function Structure**: The modules use this pattern:
   ```powershell
   function Invoke-AzureDiscovery {
       param(...)

       # Define the discovery logic as a scriptblock
       $discoveryScript = {
           param($Configuration, $Context, $SessionId, $Connections, $Result)
           # ... 1500+ lines of discovery code ...
           return $discoveredData | Group-Object -Property _DataType
       }

       # Execute using the base module orchestrator
       Start-DiscoveryModule `
           -ModuleName "AzureDiscovery" `
           -DiscoveryScript $discoveryScript `
           -Configuration $Configuration `
           -Context $Context `
           -SessionId $SessionId `
           -RequiredServices @("Graph")
   }
   ```

2. **The Bug**: In `AzureDiscovery.psm1`:
   - Lines 1743-1744 (return statement) were incorrectly indented at module level (0 spaces) instead of inside the scriptblock (8 spaces)
   - Line 1756 had an extra closing brace `}` with no matching opening brace
   - This caused a brace imbalance: 311 opening braces vs 310 closing braces (or vice versa depending on the fix attempt)

3. **Evidence**:
   - `(Get-Command Invoke-AzureDiscovery).ScriptBlock.Ast.Body.EndBlock.Statements.Count` returned `1` (should be `2`)
   - The function only contained the scriptblock definition, not the `Start-DiscoveryModule` call
   - Discovery completed in 1 second with no actual execution

### Investigation Tools Created

Created PowerShell scripts for brace analysis:
- `D:\Scripts\UserMandA\analyze-braces.ps1` - Shows brace balance at specific lines
- `D:\Scripts\UserMandA\find-balance-3.ps1` - Finds where balance transitions occur
- `D:\Scripts\UserMandA\find-unclosed-block.ps1` - Traces all brace transitions to find unclosed blocks
- `D:\Scripts\UserMandA\check-indent.ps1` - Analyzes indentation levels

### Fix Attempts

**Attempt 1**: Removed extra brace at line 1756
- Result: Created parse error - still missing closing brace somewhere

**Attempt 2**: Fixed return statement indentation (lines 1743-1744) from 0 spaces to 8 spaces, removed line 1756
- Result: Still had brace imbalance (balance ended at 1 instead of 0)

**Issue**: The 1700+ line file has nested try/catch blocks, loops, and complex structures. Manual brace matching proved error-prone.

### Recommended Solution for Other Modules

When fixing similar issues in other discovery modules:

1. **Use a working reference**: The old `/gui/` versions worked correctly - compare structure
2. **Use an IDE with brace matching**: VS Code or PowerShell ISE can highlight matching braces
3. **Test the AST structure**:
   ```powershell
   Import-Module 'path\to\module.psm1' -Force
   (Get-Command Invoke-ModuleName).ScriptBlock.Ast.Body.EndBlock.Statements.Count
   # Should return 2: one for scriptblock definition, one for Start-DiscoveryModule call
   ```

4. **Key patterns to verify**:
   - Return statement inside scriptblock should have 8 spaces indentation
   - Scriptblock closing `}` should be at 4 spaces (same level as `$discoveryScript = {`)
   - `Start-DiscoveryModule` call should be at 4 spaces (inside function, outside scriptblock)
   - Function closing `}` should be at 0 spaces

5. **Use PowerShell's built-in parser**:
   ```powershell
   $errors = $null
   [System.Management.Automation.PSParser]::Tokenize((Get-Content 'path\to\module.psm1' -Raw), [ref]$errors)
   $errors  # Will show parse errors including brace mismatches
   ```

### Modules Likely Affected

Since all modules were "standardized for the old /gui/", these modules may have similar issues:
- `AzureDiscovery.psm1` ✓ (confirmed issue)
- `ActiveDirectoryDiscovery.psm1` (check)
- `ExchangeDiscovery.psm1` (check)
- `IntuneDiscovery.psm1` (check)
- `GoogleWorkspaceDiscovery.psm1` (check)
- `AWSDiscovery.psm1` (check)
- `ConditionalAccessDiscovery.psm1` (check)
- `DataLossPreventionDiscovery.psm1` (check)
- `IdentityGovernanceDiscovery.psm1` (check)
- `LicensingDiscovery.psm1` (check)

### Additional Context Fixes Applied

During investigation, also fixed:
- Added Context null check in `Start-AzureDiscovery` wrapper function (lines 1835-1838)
- Added verbose logging to help debug execution flow
- All authentication modules previously fixed (Write-Host → Write-Verbose to prevent JSON pollution)

### Status

**Current**: Azure discovery module has unresolved brace matching issue
**Next Steps**:
1. Compare with working version from old `/gui/` directory
2. Use PowerShell parser to identify exact brace mismatch
3. Apply learnings to fix other discovery modules systematically
