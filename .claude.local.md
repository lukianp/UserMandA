# Claude Code Local Notes - UserMandA Project

## Working Directory Conventions (2025-11-06)

### Primary Working Directory
**ALL development work MUST be done in**: `C:\enterprisediscovery\`

### Sample Data Location
**Sample company with raw discovery data**: `C:\discoverydata\ljpops\`
- Contains real-world test data for development and testing
- Use this location for testing discovery modules with actual data
- Reference this path when running integration tests

### Critical Workspace Synchronization Rule
⚠️ **MANDATORY**: Any changes made to files in `C:\enterprisediscovery\` MUST be copied back to the workspace repository

**Sync Workflow**:
1. Make all edits in `C:\enterprisediscovery\`
2. Test changes locally
3. Copy modified files back to workspace (repository root)
4. Commit and push to repository

**Files requiring sync**:
- All PowerShell modules (`/Modules/*Discovery.psm1`)
- Configuration files
- Build scripts
- Documentation updates
- Any code changes in GUI or GUIV2

**Why**: The workspace repository is the source of truth. `C:\enterprisediscovery\` is the active development/testing environment with full paths, dependencies, and sample data configured.

---

## GUI vs GUIV2 Architecture Comparison (2025-11-06)

### Critical Understanding: Complete Platform Rewrite
- **OLD `/GUI/`**: WPF .NET desktop app (C#/XAML) - Windows-only
- **NEW `/guiv2/`**: Electron+React web app (TypeScript/TSX) - Cross-platform

**These are NOT iterations - completely different tech stacks. GUI is still production-ready for Windows deployments.**

### Technology Stack Matrix

| Aspect | GUI (WPF) | GUIV2 (Electron) |
|--------|-----------|------------------|
| **Platform** | Windows-only | Cross-platform |
| **Language** | C# 10 (.NET 6) | TypeScript + React |
| **UI Framework** | WPF/XAML | React + Material-UI |
| **Process Model** | Single-process | Multi-process (main/renderer) |
| **State** | ObservableCollection | Redux Toolkit |
| **Build** | MSBuild + dotnet | Webpack + Electron-forge |
| **Testing** | None visible | Jest + RTL (partial) |
| **Bundle Size** | ~50MB | ~200MB (Electron overhead) |
| **Working Dir** | `C:\enterprisediscovery\GUI\` | `C:\enterprisediscovery\guiv2\` |

### Key Architectural Differences

**GUI Strengths:**
- Native Windows performance
- Direct .NET PowerShell integration (`System.Management.Automation`)
- Smaller binary footprint
- Production-ready, tested in field
- Lightweight deployment for Windows environments

**GUIV2 Strengths:**
- Cross-platform (Windows/Mac/Linux)
- Modern React development patterns
- Better separation of concerns (IPC boundaries)
- Test infrastructure exists (needs completion)
- Easier for web developers to contribute

### Critical File Mapping

**Discovery Integration:**
- GUI: `GUI/Services/DiscoveryService.cs` - Direct in-process PS execution via .NET
- GUIV2: `guiv2/src/main/services/DiscoveryService.ts` - Spawns PowerShell child processes via IPC

**State Management:**
- GUI: `GUI/ViewModels/*ViewModel.cs` - INotifyPropertyChanged pattern, MVVM
- GUIV2: `guiv2/src/renderer/store/*.ts` - Redux Toolkit slices with async thunks

**UI Views:**
- GUI: `GUI/Views/*.xaml` + `.xaml.cs` code-behind (declarative XAML)
- GUIV2: `guiv2/src/renderer/components/views/*.tsx` - React functional components

**Main Entry Points:**
- GUI: `GUI/App.xaml.cs` - WPF Application class
- GUIV2: `guiv2/src/index.ts` (main), `guiv2/src/renderer.tsx` (renderer)

### Build Workflows

**GUI Build** (from `C:\enterprisediscovery\`):
```bash
cd C:\enterprisediscovery\GUI
dotnet restore
dotnet build MandADiscoverySuite.csproj
# Output: bin/Debug/net6.0-windows/MandADiscoverySuite.exe
```

**GUIV2 Build** (from `C:\enterprisediscovery\`):
```bash
cd C:\enterprisediscovery\guiv2
npm install
npm run build        # Webpack build
npm run make         # Create installer
# Output: out/make/squirrel.windows/x64/*.exe
```

### PowerShell Module Compatibility

**BOTH platforms** use same PowerShell discovery modules from `C:\enterprisediscovery\Modules\*Discovery.psm1`:
- GUI: Direct in-process execution via `System.Management.Automation.PowerShell` API
- GUIV2: Spawns child PowerShell processes, communicates via JSON over stdio

**Known Issue**: Discovery modules have structural bugs when called from GUIV2 (see "Discovery Module Structure Issues" section below). Same modules work perfectly in GUI due to different execution model.

**Why the difference matters**:
- GUI tolerates certain PowerShell quirks (brace mismatches in scriptblocks)
- GUIV2's process spawning model is stricter, exposes latent bugs
- Fixing these bugs improves code quality for both platforms

### Testing Status

**GUI**: 
- No automated test suite
- Production-validated through field use
- Manual testing workflows established

**GUIV2**:
- Jest + React Testing Library infrastructure
- **60% tests failing** (as of last run)
- Main issues: null safety, missing mocks, async timing
- Test files: `guiv2/src/renderer/**/*.test.tsx`

### Deployment Strategy Recommendations

1. **Continue GUI for Windows enterprise**: Proven, stable, smaller footprint
2. **Use GUIV2 for cross-platform**: Mac/Linux environments, cloud-based deployments
3. **Fix GUIV2 test suite**: Critical for production readiness
4. **Shared module maintenance**: PowerShell modules must work with both platforms

### Migration Path (if consolidating to GUIV2)

**Phase 1**: Fix test infrastructure (Priority 1)
- Resolve null safety issues in tests
- Fix discovery view component tests
- Achieve 90%+ pass rate

**Phase 2**: Performance optimization
- Reduce bundle size (currently 200MB)
- Optimize IPC communication overhead
- Implement proper lazy loading

**Phase 3**: Feature parity validation
- Ensure all GUI features replicated in GUIV2
- Validate PowerShell integration edge cases
- Test credential management flows across all discovery modules

**Current Status**: GUIV2 is functional but not production-ready. GUI remains recommended for Windows deployments. All development happens in `C:\enterprisediscovery\` with mandatory sync back to workspace repository.

---

## Discovery Module Structure Issues (2025-11-05)

### Problem Identified
The Azure discovery module (and likely other discovery modules) have a **critical structural bug** where the `Invoke-*Discovery` function has improper brace matching. This causes the `Start-DiscoveryModule` orchestration call to be positioned incorrectly.

### Root Cause
The discovery modules were standardized for the old `/gui/` application and worked there. When migrating to `guiv2`, a brace mismatch issue appeared in `AzureDiscovery.psm1`:

1. **Function Structure**: The modules use this pattern:
   ```powershell
   function Invoke-AzureDiscovery {
       param(...)

       # Define the discovery logic as a scriptblock
       $discoveryScript = {
           param($Configuration, $Context, $SessionId, $Connections, $Result)
           # ... 1500+ lines of discovery code ...
           return $discoveredData | Group-Object -Property _DataType
       }

       # Execute using the base module orchestrator
       Start-DiscoveryModule `
           -ModuleName "AzureDiscovery" `
           -DiscoveryScript $discoveryScript `
           -Configuration $Configuration `
           -Context $Context `
           -SessionId $SessionId `
           -RequiredServices @("Graph")
   }
   ```

2. **The Bug**: In `AzureDiscovery.psm1`:
   - Lines 1743-1744 (return statement) were incorrectly indented at module level (0 spaces) instead of inside the scriptblock (8 spaces)
   - Line 1756 had an extra closing brace `}` with no matching opening brace
   - This caused a brace imbalance: 311 opening braces vs 310 closing braces (or vice versa depending on the fix attempt)

3. **Evidence**:
   - `(Get-Command Invoke-AzureDiscovery).ScriptBlock.Ast.Body.EndBlock.Statements.Count` returned `1` (should be `2`)
   - The function only contained the scriptblock definition, not the `Start-DiscoveryModule` call
   - Discovery completed in 1 second with no actual execution

### Investigation Tools Created

Created PowerShell scripts for brace analysis in `C:\enterprisediscovery\`:
- `analyze-braces.ps1` - Shows brace balance at specific lines
- `find-balance-3.ps1` - Finds where balance transitions occur
- `find-unclosed-block.ps1` - Traces all brace transitions to find unclosed blocks
- `check-indent.ps1` - Analyzes indentation levels

### Fix Workflow (for all discovery modules)

**Working from `C:\enterprisediscovery\`**:

1. **Compare with GUI version**:
   ```powershell
   cd C:\enterprisediscovery
   Compare-Object (Get-Content GUI\Services\AzureDiscoveryModule.ps1) (Get-Content Modules\AzureDiscovery.psm1)
   ```

2. **Use IDE brace matching**: VS Code or PowerShell ISE to highlight matching braces

3. **Test the AST structure**:
   ```powershell
   Import-Module 'C:\enterprisediscovery\Modules\AzureDiscovery.psm1' -Force
   (Get-Command Invoke-AzureDiscovery).ScriptBlock.Ast.Body.EndBlock.Statements.Count
   # Should return 2: one for scriptblock definition, one for Start-DiscoveryModule call
   ```

4. **Use PowerShell parser**:
   ```powershell
   $errors = $null
   [System.Management.Automation.PSParser]::Tokenize((Get-Content 'C:\enterprisediscovery\Modules\AzureDiscovery.psm1' -Raw), [ref]$errors)
   $errors  # Shows parse errors including brace mismatches
   ```

5. **After fixing, sync to workspace**:
   ```powershell
   Copy-Item C:\enterprisediscovery\Modules\AzureDiscovery.psm1 <workspace_path>\Modules\AzureDiscovery.psm1
   ```

### Key Patterns to Verify

- Return statement inside scriptblock: **8 spaces** indentation
- Scriptblock closing `}`: **4 spaces** (same level as `$discoveryScript = {`)
- `Start-DiscoveryModule` call: **4 spaces** (inside function, outside scriptblock)
- Function closing `}`: **0 spaces**

### Modules Likely Affected

Since all modules were "standardized for the old /gui/", these modules in `C:\enterprisediscovery\Modules\` may have similar issues:
- `AzureDiscovery.psm1` ✓ (confirmed issue)
- `ActiveDirectoryDiscovery.psm1` (check)
- `ExchangeDiscovery.psm1` (check)
- `IntuneDiscovery.psm1` (check)
- `GoogleWorkspaceDiscovery.psm1` (check)
- `AWSDiscovery.psm1` (check)
- `ConditionalAccessDiscovery.psm1` (check)
- `DataLossPreventionDiscovery.psm1` (check)
- `IdentityGovernanceDiscovery.psm1` (check)
- `LicensingDiscovery.psm1` (check)

### Additional Context Fixes Applied

During investigation in `C:\enterprisediscovery\`, also fixed:
- Added Context null check in `Start-AzureDiscovery` wrapper function (lines 1835-1838)
- Added verbose logging to help debug execution flow
- All authentication modules previously fixed (Write-Host → Write-Verbose to prevent JSON pollution)

### Status

**Current**: Azure discovery module has unresolved brace matching issue in `C:\enterprisediscovery\Modules\AzureDiscovery.psm1`

**Next Steps**:
1. Compare with working version from old `/GUI/` directory
2. Use PowerShell parser to identify exact brace mismatch
3. Apply learnings to fix other discovery modules systematically
4. **Remember**: Always sync fixes back to workspace repository
